[å‚è€ƒ](https://railsguides.jp/active_storage_overview.html#active-storage%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6)    
[å‚è€ƒ](https://qiita.com/hmmrjn/items/7cc5e5348755c517458a#active-storage-%E3%81%A8%E3%81%AF)
  
# Active Storage
gem Carrierwaveãªã©ã‚’ä½¿ã‚ãªãã¦ã‚‚ã€ã‚ã‚‹ãƒ¬ã‚³ãƒ¼ãƒ‰ã« 1ã¤ã¾ãŸã¯è¤‡æ•°ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ·»ä»˜ã§ãã‚‹ã€‚
***

# Active Storageã‚’ä½¿ãˆã‚‹ã‚ˆã†ã«ã™ã‚‹
~~~
$ rails active_storage:install
$ rails db:migrate
~~~
ã“ã®ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã«ã‚ˆã£ã¦  
  
- active_storage_blobs    
å®Ÿéš›ã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ãŸãƒ•ã‚¡ã‚¤ãƒ«ãŒä¿å­˜ã•ã‚Œã‚‹ãƒ†ãƒ¼ãƒ–ãƒ«  
(å®Ÿéš›ã¯ãƒ•ã‚¡ã‚¤ãƒ«åã€ãƒ•ã‚¡ã‚¤ãƒ«ã®ç¨®é¡ã€ãƒã‚¤ãƒˆæ•°ã€èª¤ã‚Šæ¤œå‡ºç¬¦å·ãªã©ã®ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’ä¿æŒã™ã‚‹ãƒ†ãƒ¼ãƒ–ãƒ«)  
    
- active_storage_attachments  
å®Ÿéš›ã«æ“ä½œã‚’è¡Œã†ãƒ¢ãƒ‡ãƒ«ã¨ active_storage_blobsã‚’ç´ã¥ã‘ã‚‹ä¸­é–“ãƒ†ãƒ¼ãƒ–ãƒ«

  
ã¨ã„ã†ï¼’ã¤ã®ãƒ†ãƒ¼ãƒ–ãƒ«ç”Ÿæˆã•ã‚Œã€ãã‚Œãã‚Œ Blobã¨ Attachmentã¨ã„ã†ã®2ã¤ã®ãƒ¢ãƒ‡ãƒ«ãŒä½¿ã†ã€‚  
ãªãŠã€Active Storageã‚’ä½¿ã†éš›ã€ç›´æ¥ Blobã¨ Attachmentãƒ¢ãƒ‡ãƒ«ã«è§¦ã‚Œã‚‹å¿…è¦ã¯ãªã„ã€‚  
***

# Active Record ãƒ¢ãƒ‡ãƒ«ã‚’ç”¨æ„ã™ã‚‹
ä¾‹ãˆã°ã€è¨˜äº‹ï¼ˆArticleï¼‰ã«ä¸€æšç”»åƒã‚’æ·»ä»˜ã§ãã‚‹ã‚ˆã†ã«ã—ãŸã„ã€‚  
  
- ç”»åƒã‚’ä¸€æšæ·»ä»˜ã—ãŸã„å ´åˆ...`has_one_attached :ãƒ•ã‚¡ã‚¤ãƒ«ã®å‘¼ã³å(å˜æ•°ç³»)`      
- ç”»åƒã‚’è¤‡æ•°æ·»ä»˜ã—ãŸã„å ´åˆ...`has_many_attached :ãƒ•ã‚¡ã‚¤ãƒ«ã®å‘¼ã³å(è¤‡æ•°å½¢)`
  
âš ï¸ å˜æ•°ç³»ã‹è¤‡æ•°å½¢ã‹é–“é•ãˆãªã„ã‚ˆã†ã«ï¼
~~~
[app/models/article.rb]

class Article < ApplicationRecord
  has_one_attached :eye_catch
end
~~~
:eye_catchã¯ãƒ•ã‚¡ã‚¤ãƒ«ã®å‘¼ã³åã§ã€:photoã€:avatarã€:hogeãªã©ã€ãƒ•ã‚¡ã‚¤ãƒ«ã®ç”¨é€”ã«åˆã‚ã›ã¦å¥½ããªã‚‚ã®ã‚’æŒ‡å®šã—ã¦OKã€‚  
ã“ã“ã§ eye_catchã‚«ãƒ©ãƒ ã‚„ã€Imageãƒ¢ãƒ‡ãƒ«ãªã©ã‚’ä½œã‚‹å¿…è¦ã¯ãªã„ã€‚  
Active Storageã¯è£å´ã§ Blobã¨ Attachmentãƒ¢ãƒ‡ãƒ«ã‚’ä½¿ã£ã¦ã€ã“ãã“ãã¨ article.imageã‚’ä½¿ãˆã‚‹ã‚ˆã†ã«ã—ã¦ãã‚Œã‚‹ã€‚
***

# ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼ç·¨é›†
- â‘  æ–°ãŸã«ä½œæˆã™ã‚‹è¨˜äº‹ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒç”»åƒã‚’è¿½åŠ ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹ã€‚
- â‘¡ ã‚¹ãƒˆãƒ­ãƒ³ã‚°ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒ¼ã«ã€Œ:eye_catchã€ã‚’å…¥ã‚Œã‚‹ã€‚
~~~
[app/controllers/article_controller.rb]

def create
  authorize(Article)

  @article = Article.new(article_params)
  @article.state = :draft
ã€€â‘ @article.eye_catch.attach(params[:article][:eye_catch])

  if @article.save
    redirect_to edit_admin_article_path(@article.uuid)
  else
    render :new
  end
end

private

def article_params
  â‘¡params.require(:article).permit(:title, :description, :slug, :state, :published_at, :eye_catch, :category_id, :author_id, :eyecatch_width, :eyecatch_align, tag_ids: [])
end
~~~
â€» â‘ ã®ã‚³ãƒ¼ãƒ‰ãªãã¦ã‚‚å‹•ãã®ã§å¿…è¦æ€§ãŒã„ã¾ã„ã¡ã‚ã‹ã‚‰ãªã„ã€‚
***

## è¤‡æ•°ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ·»ä»˜ã™ã‚‹ã¨ã
`:eye_catchs`ã®æ›¸ãæ–¹ã ã¨ä¸€æšãšã¤æ·»ä»˜ã‚’ç¹°ã‚Šè¿”ã™ã¨è¤‡æ•°æšè²¼ã‚Œã‚‹ã€‚
~~~
params.require(:article).permit(:title, :description, :slug, :state, :published_at, :eye_catchs, :category_id, :author_id, :eyecatch_width, :eyecatch_align, tag_ids: [])
~~~
  
`eye_catchs: []`ã®æ›¸ãæ–¹ã ã¨ä¸€æ°—ã«é¸ã‚“ã§è²¼ã‚Œã‚‹ã€‚ 
~~~
params.require(:article).permit(:title, :description, :slug, :state, :published_at, :category_id, :author_id, :eyecatch_width, :eyecatch_align, tag_ids: [], eye_catchs [])
~~~
***

# ãƒ“ãƒ¥ãƒ¼ã®ç·¨é›†(ãƒ•ã‚©ãƒ¼ãƒ )
~~~
[app/views/articles/new.html.erb]

<%= simple_form_for @article, url: admin_article_path(@article.uuid) do |f| %>
  <%= f.input :eye_catch, as: :file %>
<% end %>
~~~
ğŸ’¡ simple_formä½¿ã£ã¦ã‚‹ã®ã§ã€€`as: :file`ã¨ã„ã†ã‚ˆã†ãªæ›¸ãæ–¹ã—ã¦ã‚‹ã‘ã©  
  form_withãªã‚‰`f.file_field`ã«ãªã‚‹
***

## è¤‡æ•°ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ·»ä»˜ã™ã‚‹ã¨ã
- `multiple: true`ã‚’ã¤ã‘ã‚‹ã€‚  
- ãƒ•ã‚¡ã‚¤ãƒ«åã‚’è¤‡æ•°å½¢ã«ã™ã‚‹ã€‚    
~~~
<%= simple_form_for @article, url: admin_article_path(@article.uuid) do |f| %>
  <%= f.input :eye_catchs, as: :file, input_html: { multiple: true } %>
<% end %>
~~~
***

## â­ï¸ accept:ã§æœ‰åŠ¹ãªç”»åƒãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã‚’ã‚ã‹ã‚Šã‚„ã™ãã™ã‚‹
~~~
<%= f.input :eye_catch, as: :file,  %>

# ãƒ“ãƒ¥ãƒ¼ã®ç·¨é›†(è¡¨ç¤º)
image_tagã«æ¸¡ã™ã ã‘ï¼
~~~
[app/views/articles/show.html.erb]

<% if @article.eye_catch.attached? %>
  <%= image_tag @article.eye_catch %>
<% end %>
~~~
***

## è¤‡æ•°ãƒ•ã‚¡ã‚¤ãƒ«ã‚’è¡¨ç¤ºã™ã‚‹ã¨ã
- ãƒ•ã‚¡ã‚¤ãƒ«åã‚’è¤‡æ•°å½¢ã«ã™ã‚‹ã€‚(eye_catch => eye_catchs)
~~~
<% if @article.eye_catchs.attached? %>
  <% @article.eye_catchs.each do |eye_catch| %>
    <%= image_tag eye_catch %> <br>
  <% end %>
<% end %>
~~~
***

# ãƒ•ã‚¡ã‚¤ãƒ«ã®ä¿å­˜å…ˆã®å¤‰æ›´
ãƒ•ã‚¡ã‚¤ãƒ«ã®ä¿å­˜å…ˆã¯ã€å„ç’°å¢ƒã®è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã«è¨˜è¼‰ã™ã‚‹ã€‚  
ã¾ãšã¯ã€ config/environments/development.rb ã¨ production.rb ã®ä¸­èº«ã‚’è¦‹ã¦ã¿ã‚‹ã€‚
~~~
[config/environments/development.rb]

config.active_storage.service = :local


[config/environments/production.rb]

config.active_storage.service = :local
~~~
åˆæœŸçŠ¶æ…‹ã§ã¯ã€é–‹ç™ºç’°å¢ƒ(development)ã€æœ¬ç•ªç’°å¢ƒ(production)ã¨ã‚‚ã«ä¿å­˜å…ˆã¯ :local ã«è¨­å®šã•ã‚Œã¦ã„ã‚‹ã€‚  
ã“ã® localã¨ã¯ã€ã€Œconfig/storage.ymlã€ã§å®šç¾©ã•ã‚ŒãŸä¿å­˜å…ˆã®åå‰ã€‚  

ã“ã‚Œã‚’å¤‰æ›´ã™ã‚‹ã«ã¯ã€:local ã®ã¨ã“ã‚ã‚’ :amazon, :google, :microsoft ã®ã„ãšã‚Œã‹ã¨ç½®ãæ›ãˆã€  
ã€Œconfig/storage.ymlã€ã®æ–¹ã«ã€å¿…è¦ãªèªè¨¼æƒ…å ±ãªã©ã®å€¤ã‚’å…¥åŠ›ã™ã‚‹ã€‚  
***

## config/storage.yml
~~~
[config/storage.yml]

test:
  service: Disk
  root: <%= Rails.root.join("tmp/storage") %>

local:
  service: Disk
  root: <%= Rails.root.join("storage") %>

# Use rails credentials:edit to set the AWS secrets (as aws:access_key_id|secret_access_key)
# amazon:
#   service: S3
#   access_key_id: <%= Rails.application.credentials.dig(:aws, :access_key_id) %>
#   secret_access_key: <%= Rails.application.credentials.dig(:aws, :secret_access_key) %>
#   region: us-east-1
#   bucket: your_own_bucket

# Remember not to checkin your GCS keyfile to a repository
# google:
#   service: GCS
#   project: your_project
#   credentials: <%= Rails.root.join("path/to/gcs.keyfile") %>
#   bucket: your_own_bucket

# Use rails credentials:edit to set the Azure Storage secret (as azure_storage:storage_access_key)
# microsoft:
#   service: AzureStorage
#   storage_account_name: your_account_name
#   storage_access_key: <%= Rails.application.credentials.dig(:azure_storage, :storage_access_key) %>
#   container: your_container_name
~~~
å…ˆã»ã©è¦‹ãŸä¿å­˜å…ˆã® localã¯ã€ä½¿ç”¨ã™ã‚‹ã‚µãƒ¼ãƒ“ã‚¹ãŒ Disk(ãƒ­ãƒ¼ã‚«ãƒ«ãƒ‡ã‚£ã‚¹ã‚¯)ã«è¨­å®šã•ã‚Œã¦ã„ã¦ã€  
railsã‚¢ãƒ—ãƒªç›´ä¸‹ã®ã€Œ/storageã€ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒãƒ•ã‚¡ã‚¤ãƒ«ã®ä¿å­˜å…ˆã«æŒ‡å®šã•ã‚Œã¦ã„ã‚‹ã€‚  
      
ä»–ã®ã‚‚ã®ã«ã—ãŸã„ã¨ãã¯ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆã•ã‚Œã¦ã‚‹ä¸­ã‹ã‚‰  
é©åˆ‡ãªã¨ã“ã‚ã®ã‚³ãƒ¡ãƒ³ãƒˆã‚’è§£é™¤ã™ã‚‹ã“ã¨ã§ã€å¥½ããªã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚µãƒ¼ãƒ“ã‚¹ã‚’ä½¿ãˆã‚‹ã€‚  
ã¾ãŸã€ä½¿ã†ã‚µãƒ¼ãƒ“ã‚¹ã® gemã‚’ Gemfileã«è¿½è¨˜ã™ã‚‹å¿…è¦ãŒã‚ã‚‹ã€‚  
ã“ã‚Œã¯ã€aws-sdk-s3, google-cloud-storage, azure-storageã®ã„ãšã‚Œã‹ã€‚  
  
ã¾ã å®Ÿè£…ã—ãŸã“ã¨ãªã„ã®ã§ã—ãŸã‚‰ã¾ãŸè©³ã—ãã¾ã¨ã‚ã‚‹ã€‚
***

# ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
[Gemã‚ã‚Š](https://github.com/Tarara33/TIL/blob/main/Rails/Gem/active_storage_validations.md)  
[Gemãªã—](https://github.com/Tarara33/TIL/tree/main/Rails/Model/%E3%83%90%E3%83%AA%E3%83%87%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3/Active%20Storage)
***
