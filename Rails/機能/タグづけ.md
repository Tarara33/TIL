# ã‚¿ã‚°ã¥ã‘
[![Image from Gyazo](https://i.gyazo.com/0bd008122a13ecbc3fa7af4bd3458ce2.png)](https://gyazo.com/0bd008122a13ecbc3fa7af4bd3458ce2)    
ã“ã®é’ä¸¸ã®ã‚ˆã†ã«æŠ•ç¨¿ã«ã‚¿ã‚°ã¥ã‘ã‚’è¡Œã†ã€‚
***

# æ¡ä»¶
- â‘ è¤‡æ•°ã®ã‚¿ã‚°ã‚’ç™»éŒ²ã§ãã‚‹ã€‚    
- â‘¡æ—¢ã«ã‚¿ã‚°ãƒ†ãƒ¼ãƒ–ãƒ«ã«ç™»éŒ²ã•ã‚Œã¦ã„ã‚‹ã‚¿ã‚°ãŒå­˜åœ¨ã™ã‚‹å ´åˆã¯ã€æ–°ãŸã«ç™»éŒ²ã™ã‚‹ã®ã§ã¯ãªãã€æ—¢å­˜ã®ã‚‚ã®ã‚’ä½¿ç”¨ã™ã‚‹ã€‚    
- â‘¢æŠ•ç¨¿ã«å¤±æ•—ã—ã¦æŠ•ç¨¿ãƒ•ã‚©ãƒ¼ãƒ ã«æˆ»ã£ã¦ããŸéš›ã«ã¯ã€ã‚¿ã‚°ã®å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«å…¥åŠ›ã—ãŸå€¤ãŒãã®ã¾ã¾è¡¨ç¤ºã•ã‚Œã‚‹ã€‚    
- â‘£åŒã˜ã‚¿ã‚°ãŒè¤‡æ•°å€‹å…¥åŠ›ã•ã‚ŒãŸå ´åˆã§ã‚‚ã€ã‚¿ã‚°ãƒ†ãƒ¼ãƒ–ãƒ«ã«ã¯1ä»¶ã®ã¿ç™»éŒ²ã•ã‚Œã‚‹ã€‚
***

# ãƒ¢ãƒ‡ãƒ«ä½œæˆ
[![Image from Gyazo](https://i.gyazo.com/98e8bfefebe5d640d3f4b46fb30fda62.png)](https://gyazo.com/98e8bfefebe5d640d3f4b46fb30fda62)    
    
ä¸€ã¤ã®Postã¯å¤šæ•°ã® Tagã‚’æŒã¤ã€‚    
ä¸€ã¤ã®Tagã¯è¤‡æ•°ã®ã€€Postcã‚’æŒã¤ã€‚    
=> å¤šå¯¾å¤šã®é–¢ä¿‚ï¼ã€€
***

## ä¸­é–“ãƒ†ãƒ¼ãƒ–ãƒ«ã¯ã©ã¡ã‚‰ã§ä½œã‚‹ã‹
has_many_through ã¨ has_and_belongs_to_manyã©ã¡ã‚‰ã§æº–å‚™ã™ã‚‹ã‹ã€‚    
é•ã„ãªã©ã¯[ã“ã¡ã‚‰](https://github.com/Tarara33/TIL/blob/main/Rails/Model/%E3%82%A2%E3%82%BD%E3%82%B7%E3%82%A8%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3/%E3%82%A2%E3%82%BD%E3%82%B7%E3%82%A8%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3.md)ã§ç¢ºèªã€‚    
    
ä»Šå›ã¯ã“ã®ã‚ˆã†ã«è¤‡æ•°å›åŒã˜ã‚„ã¤ãŒå…¥åŠ›ã•ã‚Œã¦ã‚‚ã€ä¸€ä»¶ã ã‘ã«ãªã‚‹ã‚ˆã†ã«ã—ãŸã„ã®ã§ã€  
[![Image from Gyazo](https://i.gyazo.com/7f9e697213e9806d75d5385dd4f77f5c.png)](https://gyazo.com/7f9e697213e9806d75d5385dd4f77f5c)    
[![Image from Gyazo](https://i.gyazo.com/18a80627f0fdc14070d023e0b65b6dfd.png)](https://gyazo.com/18a80627f0fdc14070d023e0b65b6dfd)     
ä¸­é–“ãƒ†ãƒ¼ãƒ–ãƒ«ã«ã€Œpost_id: tag_idã€ã®çµ„ã¿åˆã‚ã›ã¯ä¸€æ„æ€§ã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ãŒå¿…è¦ã«ãªã‚‹ã€‚
ãã®ãŸã‚ã€has_many_throughã‚’ä½¿ã†ï¼
***

# ãƒ¢ãƒ‡ãƒ«ä½œæˆ
~~~
$ rails g model Tag name:string
=> Tagãƒ†ãƒ¼ãƒ–ãƒ«

$ rails g model PostTagRelation post:references tag:references
=> ä¸­é–“ãƒ†ãƒ¼ãƒ–ãƒ«
~~~
***

# ã‚¢ã‚½ã‚·ã‚¨ãƒ¼ã‚·ãƒ§ãƒ³ãƒ»ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
~~~
[app/models/tag.rb]
class Tag < ApplicationRecord
  has_many :post_tag_relations, dependent: :destroy
  has_many :posts, through: :post_tag_relations

  validates :name, uniqueness: true
=> ğŸŒæ¡ä»¶â‘¡æ—¢ã«ã‚¿ã‚°ãƒ†ãƒ¼ãƒ–ãƒ«ã«ç™»éŒ²ã•ã‚Œã¦ã„ã‚‹ã‚¿ã‚°ãŒå­˜åœ¨ã™ã‚‹å ´åˆã¯ã€æ–°ãŸã«ç™»éŒ²ã™ã‚‹ã®ã§ã¯ãªãã€æ—¢å­˜ã®ã‚‚ã®ã‚’ä½¿ç”¨ã™ã‚‹ã€‚  
end
~~~

~~~
[app/models/post.rb]
class Post < ApplicationRecord
  has_many :post_tag_relations, dependent: :destroy
  has_many :tags, through: :post_tag_relations
end
~~~

~~~
[app/models/post_tag_relation.rb]
class PostTagRelation < ApplicationRecord
  belongs_to :post
  belongs_to :tag

  validates :post_id, presence: true
  validates :tag_id, presence: true
=> ä¸€å¿œã¤ã‘ã¦ã¿ãŸã€‚

  validates :post_id, uniqueness: {scope: :tag_id}
=> ğŸŒæ¡ä»¶â‘£åŒã˜ã‚¿ã‚°ãŒè¤‡æ•°å€‹å…¥åŠ›ã•ã‚ŒãŸå ´åˆã§ã‚‚ã€ã‚¿ã‚°ãƒ†ãƒ¼ãƒ–ãƒ«ã«ã¯1ä»¶ã®ã¿ç™»éŒ²ã•ã‚Œã‚‹ã€‚
end
~~~
***

## ãªãœè¤‡æ•°å›åŒã˜ã‚¿ã‚°ã¤ã‘ã¦æŠ•ç¨¿ã—ã¦ã‚‚ä¸€ã¤ã«ã§ãã‚‹ï¼Ÿï¼Ÿ
~~~
validates :post_id, uniqueness: {scope: :tag_id}
~~~
ã“ã‚ŒãŒã‚ã‚‹ã¨ã€ã€Œpost_id :tag_idã€ã®çµ„ã¿åˆã‚ã›ãŒä¸€æ„æ€§ã‹ã‹ã‚‹ã®ã§ã€
ä¾‹ãˆã° {post_id:1, body: 'ã‚ã„ã†'}ã®æŠ•ç¨¿ã«ã¯ã€{tag_id: 1, name: 'abc'}ã¨ã®çµ„ã¿åˆã‚ã›ã¯ä¸€ã¤ã—ã‹ä½œã‚Œãªããªã‚‹ãŸã‚ã€‚
~~~
â­•ï¸{post_id:1, body: 'ã‚ã„ã†'} + {tag_id: 1, name: 'abc'}
âŒ{post_id:1, body: 'ã‚ã„ã†'} + {tag_id: 1, name: 'abc'}  #ï¼’å›ç›®ã¯ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‹ã‹ã‚‹
â­•ï¸{post_id:2, body: 'ã‚ã‚’ã‚“'} + {tag_id: 1, name: 'abc'}
â­•ï¸{post_id:1, body: 'ã‚ã„ã†'} + {tag_id: 2, name: 'xyz'}
~~~
***

# ãƒ•ã‚©ãƒ¼ãƒ ç”»é¢ç·¨é›†
Tagã®å€¤ã‚‚å…¥åŠ›ã§ãã‚‹ã‚ˆã†ã«ç·¨é›†ã€‚
~~~
[app/views/posts/_post.html.erb]
<%= form_with model: post do |f| %>
  <%= render 'shared/error_message', object: f.object %>
  <div class="mb-3">
    <%= f.label :title %>
    <%= f.text_field :title, class: 'form-control' %>

  <div class="mb-3">
    <%= f.label :body %>
    <%= f.text_field :body class: 'form-control' %>
  </div>

  â­ï¸<div class="mb-3">
    <%= f.label :tag_names %>
    <%= f.text_field :tag_names, class: 'form-control', placeholder: ",ã§åŒºåˆ‡ã£ã¦å…¥åŠ›ã—ã¦ãã ã•ã„", value: tags %>
  </div>

  <%= f.submit class: 'btn btn-primary'  %>
<% end %>
~~~
â­ï¸éƒ¨åˆ†ãŒã‚¿ã‚°ã®ãƒ•ã‚©ãƒ¼ãƒ å…¥åŠ›æ¬„ã§ã€Postãƒ¢ãƒ‡ãƒ«ã¸ã®ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡æ™‚ã«ä¸€ç·’ã«é€ã‚‰ã‚Œã‚‹ã€‚    
ã“ã®ã¾ã¾ã ã¨ã€æŠ•ç¨¿ã®ä½œæˆã¯ã§ãã¦ã‚‚ã€Tagãƒ†ãƒ¼ãƒ–ãƒ«ã«å€¤ãŒä¿å­˜ã•ã‚Œãªã„ã®ã§ã€ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼å†…ã§ãã‚Œã‚’ç·¨é›†ã™ã‚‹ã€‚
***

# ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼ç·¨é›†
~~~
[ç·¨é›†å‰]
[app/controllers/post_controller.rb]

def create
  @post = current_user.posts.new(post_params)

  if @post.save
    redirect_to post_path(@post), success: 'ãƒã‚¹ãƒˆã‚’ä½œæˆã—ã¾ã—ãŸ'
  else
    flash.now[:danger] = 'ãƒã‚¹ãƒˆã‚’ä½œæˆã§ãã¾ã›ã‚“ã§ã—ãŸ'
    render :new
  end
  end
~~~

~~~
[ç·¨é›†å¾Œ]

def create
  @post = current_user.posts.new(post_params)
â‘ tag_list = params[:post][:tag_names].split(',')

  if @post.save
  â‘¡@post.save_tags(tag_list)
    redirect_to post_path(@post), success: 'ãƒã‚¹ãƒˆã‚’ä½œæˆã—ã¾ã—ãŸ'
  else
    flash.now[:danger] = 'ãƒã‚¹ãƒˆã‚’ä½œæˆã§ãã¾ã›ã‚“ã§ã—ãŸ'
  â‘¢@tags = params[:post][:tag_names].split(',')
    render :new
  end
end
~~~
***

## è§£èª¬â‘  
æ¤œè¨¼ã§ç¢ºèªã™ã‚‹ã¨ã€Tagã®å€¤ã¯ ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒ¼ã®[:post]ã®[:tag_names]ã«å…¥ã£ã¦ã„ã‚‹ã®ã§    
[![Image from Gyazo](https://i.gyazo.com/7ab95c6284fc99bc403ddd94b82a37c0.png)](https://gyazo.com/7ab95c6284fc99bc403ddd94b82a37c0)         
ã“ã‚Œã‚’ splitãƒ¡ã‚½ãƒƒãƒ‰ã§ã‚³ãƒ³ãƒã§åŒºåˆ‡ã£ã¦é…åˆ—ã«ã—ã¦å¤‰æ•° tag_listã«å…¥ã‚Œã‚‹ã€‚
~~~
[rails c]
$ a = "a,f,g"
=> "a,s,d"

$ a.split(',')
=> ["a", "f", "g"]
~~~
***

## è§£èª¬â‘¡
@postãŒ saveã•ã‚ŒãŸã‚‰ã€ @postã§save_tagsãƒ¡ã‚½ãƒƒãƒ‰ã‚’å‘¼ã‚“ã§ã„ã‚‹ã€‚    
ã“ã‚Œã¯ã‚ªãƒªã‚¸ãƒŠãƒ«ãƒ¡ã‚½ãƒƒãƒ‰ãªã®ã§ã€postãƒ¢ãƒ‡ãƒ«ã§å®šç¾©ã™ã‚‹ã€‚
~~~
[app/models/post.rb]

ğŸŒæ¡ä»¶â‘ è¤‡æ•°ã®ã‚¿ã‚°ã‚’ç™»éŒ²ã§ãã‚‹ã€‚
def save_tags(tags)
  â‘ current_tags = self.tags.pluck(:name) unless self.tags.nil?
  â‘¡old_tags = current_tags - tags
  â‘¢new_tags = tags - current_tags

  â‘£old_tags.each do |old_name|
    self.tags.delete Tag.find_by(name:old_name)
  end

  â‘¤new_tags.each do |new_name|
    new_tag = Tag.find_or_create_by(name: new_name)
    self.tags << new_tag
  end
end
~~~
ğŸ’¡ ã“ã®ãƒ¡ã‚½ãƒƒãƒ‰å†…ã® selfã¯ãƒ¡ã‚½ãƒƒãƒ‰ã‚’å‘¼ã‚“ã @postã®ã“ã¨ã€‚    
    
â‘  unlessã¤ã„ã¦ã‚‹ã®ã§ã€ã‚‚ã—@post.tagsãŒ nilã˜ã‚ƒãªã‘ã‚Œã°ã€    
å¤‰æ•°current_tagsã«ã€€@post.tagsã®nameã‚«ãƒ©ãƒ ã®é…åˆ—ã‚’å…¥ã‚Œã‚‹ã€‚
    
â‘¡ å¤‰æ•°old_tagsã«ã¯ã€å¤‰æ•°current_tagã‹ã‚‰ã€ä»Šãƒ•ã‚©ãƒ¼ãƒ ã§é€ã‚‰ã‚Œã¦ããŸtag(tag_list)ã‚’å¼•ã„ãŸã‚‚ã®ã‚’å…¥ã‚Œã‚‹ã€‚    
    
â‘¢ å¤‰æ•°new_tagsã«ã¯ã€ä»Šãƒ•ã‚©ãƒ¼ãƒ ã§é€ã‚‰ã‚Œã¦ããŸtag(tag_list)ã‹ã‚‰ã€å¤‰æ•°current_tagã‚’å¼•ã„ãŸã‚‚ã®ã‚’å…¥ã‚Œã‚‹ã€‚    
    
â‘£ å¤‰æ•°old_tagsã®é…åˆ—ã‚’ã€€eachæ–‡ã§ä¸€ã¤ãšã¤å–ã‚Šå‡ºã—ã€    
Tagãƒ†ãƒ¼ãƒ–ãƒ«ã§ nameã‚«ãƒ©ãƒ ã§æ¤œç´¢ã—ã¦è¦‹ã¤ã‘ãŸã‚‰ã€@post.tagsã‹ã‚‰å‰Šé™¤ã—ã¦ã„ã‚‹ã€‚      
        
â‘¤ å¤‰æ•°new_tagsã®é…åˆ—ã‚’ã€€eachæ–‡ã§ä¸€ã¤ãšã¤å–ã‚Šå‡ºã—ã€    
Tagãƒ†ãƒ¼ãƒ–ãƒ«ã§ nameã§æ¤œç´¢ã—ã¦è¦‹ã¤ã‘ã‚‹ or è¦‹ã¤ã‹ã‚‰ãªã‘ã‚Œã°DBã«ä¿å­˜ã—ã¦å¤‰æ•°new_tagã«å…¥ã‚Œã‚‹ã€‚    
ãã—ã¦ã€@post.tagsã«å¤‰æ•°new_tagã®å€¤ã‚’å…¥ã‚Œã‚‹ã€‚    
    
ã‚ã‹ã‚Šã«ãã„ã®ã§ä¾‹ãˆå‡ºã™ã¨
~~~
å…ƒã€…ã€@postã¯tagsã§ã€€["é­š", "è‚‰", "é‡èœ", "åµ"]ã‚’æŒã£ã¦ã„ãŸã¨ã™ã‚‹ã€‚
ãã—ã¦ tag_listã« ["ç‰›ä¹³", "è‚‰"]ãŒé€ã‚‰ã‚Œã¦ããŸã¨ã™ã‚‹ã€‚

current_tagsã€€= ã€€["é­š", "è‚‰", "é‡èœ", "åµ"]
old_tags = ã€€["é­š", "è‚‰", "é‡èœ", "åµ"] - ["ç‰›ä¹³", "è‚‰"] = ["é­š", "é‡èœ", "åµ"]
new_tags = ["ç‰›ä¹³", "è‚‰"] - ã€€["é­š", "è‚‰", "é‡èœ", "åµ"] = ["ç‰›ä¹³"]

@post.tagsã‹ã‚‰ã€€["é­š", "é‡èœ", "åµ"]ã®å€¤ã‚’æ¶ˆã™ã€‚
@post.tagsã« ["ç‰›ä¹³"]ã®å€¤ã‚’è¿½åŠ ã™ã‚‹ã€‚

çµæœã€@post.tagsã¯ ["ç‰›ä¹³", "è‚‰"]ã«ãªã‚‹ã€‚
~~~
âš ï¸ æ–°è¦ä½œæˆã®æ™‚ã¯ current_tagsã¯ç©ºã§ nilãªã®ã§[]ã€‚        
old_tagsã‚‚ãªã„ã®ã§ã€å®Ÿè¡Œã•ã‚Œã‚‹ã®ã¯â‘¤ã®new_tagsã®å‡¦ç†ã ã‘ã€‚            
ã—ã‹ã— updateã§ã‚‚ã“ã®ãƒ¡ã‚½ãƒƒãƒ‰ãŒä½¿ãˆã‚‹ã‚ˆã†ã«ã“ã®ã‚ˆã†ã«ã¾ã¨ã‚ã¦æ›¸ã„ã¦ã„ã‚‹ã€‚        
(ã¾ã¨ã‚ãªã„ã¨æ–°è¦ä½œæˆç”¨ã¨æ›´æ–°ç”¨ã¨ï¼’ã¤ãƒ¡ã‚½ãƒƒãƒ‰æ›¸ãå¿…è¦ã‚ã‚‹ãŸã‚ã€‚)
***

## è§£èª¬â‘¢
ğŸŒæ¡ä»¶â‘¢æŠ•ç¨¿ã«å¤±æ•—ã—ã¦æŠ•ç¨¿ãƒ•ã‚©ãƒ¼ãƒ ã«æˆ»ã£ã¦ããŸéš›ã«ã¯ã€ã‚¿ã‚°ã®å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«å…¥åŠ›ã—ãŸå€¤ãŒãã®ã¾ã¾è¡¨ç¤ºã•ã‚Œã‚‹ã€‚         
ã“ã‚Œã‚’å®Ÿè£…ã™ã‚‹ãŸã‚ã«æ›¸ã„ã¦ã„ã‚‹ã€‚     
            
é€šå¸¸ã€Postãƒ¢ãƒ‡ãƒ«ã®å€¤(titleãƒ»body)ã¯ renderã•ã‚Œã¦ã‚‚@postã«å€¤ãŒä¸€æ™‚ä¿å­˜ã•ã‚Œã¦ã‚‹ã®ã§æ¶ˆãˆãªã„ãŒã€tag_namesã¯æ¶ˆãˆã¦ã—ã¾ã†ã€‚        
ãªã®ã§ã€€viewãƒ•ã‚¡ã‚¤ãƒ«ã§æ›¸ã„ãŸ value: tagsã®éƒ¨åˆ†ã«ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿[:post][:tag_names]ã®å€¤ã‚’å…¥ã‚Œç›´ã™ã€‚
~~~
<%= f.text_field :tag_names, class: 'form-control', placeholder: ",ã§åŒºåˆ‡ã£ã¦å…¥åŠ›ã—ã¦ãã ã•ã„", value: tags %>
~~~
âš ï¸ renderã®ä¸‹ã«ã‹ãã¨åæ˜ ã•ã‚Œãªã‹ã£ãŸã®ã§ã€æ›¸ãå ´æ‰€å¤§åˆ‡ã£ã½ã„ã€‚
***

# updateã‚¢ã‚¯ã‚·ãƒ§ãƒ³
~~~
[app/controllers/post_controller.rb]
def update
  @post = current_user.posts.find(params[:id])
  tag_list = params[:post][:tag_names].split(',')
  
  if @post.update(post_params)
    @post.save_tags(tag_list)
    redirect_to post_path(@post), success: 'ãƒã‚¹ãƒˆã‚’æ›´æ–°ã—ã¾ã—ãŸ'
  else
    flash.now[:danger] = 'ãƒã‚¹ãƒˆã‚’æ›´æ–°ã§ãã¾ã›ã‚“ã§ã—ãŸ'
    @tags = params[:post][:tag_names].split(',')
    render :edit
  end
end
~~~
ã»ã¼ createã¨åŒã˜ã€‚
***

# ãƒ“ãƒ¥ãƒ¼ç·¨é›†
showãƒšãƒ¼ã‚¸ãªã©ã«è¡¨ç¤ºã™ã‚‹ã€‚        
ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼ã« showã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã§ã‚‚ä½¿ãˆã‚‹@tagså®šç¾©ã™ã‚‹ã€‚
~~~
[app/controllers/post_controller.rb]
def show
  @post = Post.includes(:tags).find(params[:id])
  @tags =@post.tags.pluck(:name).join(',')
end
~~~

ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã‚’æ°—ã«ã—ã¦ã¿ãŸæ›¸ãæ–¹
~~~
[app/views/posts/show.html.erb]
<div class="card-footer">
  <%= render partial: 'tag', collection: @post.tags %>
</div>


[app/views/posts/_tag.html.erb]
<a class="badge rounded-pill bg-primary text-decoration-none text-white" href="/posts?tag_name=<%= tag.name %>"><%= tag.name %></a>
~~~

ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°æ°—ã«ã—ãªã„æ›¸ãæ–¹
~~~
[app/views/posts/show.html.erb]

<% @post.tags.each do |tag| %>
  <a class="badge rounded-pill bg-primary text-decoration-none text-white" href="/posts?tag_name=<%= tag.name %>"><%= tag.name %></a>
<% end %>
~~~
***
