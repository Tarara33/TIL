# å®Ÿè£…å†…å®¹
- è¨˜äº‹ã®å…¬é–‹äºˆå®šæ—¥ã‚’æœªæ¥ã«ã—ã¦ã€Œæ›´æ–°ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã™ã¨    
ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãŒã€Œå…¬é–‹å¾…ã¡ã€+ã€Œæ›´æ–°ã—ã¾ã—ãŸã€ã®ãƒ•ãƒ©ãƒƒã‚·ãƒ¥ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸  
  
- è¨˜äº‹ã®å…¬é–‹äºˆå®šæ—¥ã‚’éå»ã«ã—ã¦ã€Œæ›´æ–°ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã™ã¨    
ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãŒã€Œå…¬é–‹ã€+ã€Œæ›´æ–°ã—ã¾ã—ãŸã€ã®ãƒ•ãƒ©ãƒƒã‚·ãƒ¥ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸  
  
- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãŒã€Œä¸‹æ›¸ãã€ã®è¨˜äº‹ã¯ãã®ã¾ã¾  
    
- è¨˜äº‹ã®å…¬é–‹äºˆå®šæ—¥ã‚’æœªæ¥ã«ã—ã¦ã€Œå…¬é–‹ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã™ã¨  
ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãŒã€Œå…¬é–‹å¾…ã¡ã€+ã€Œå…¬é–‹å¾…ã¡ã«ã—ã¾ã—ãŸã€ã®ãƒ•ãƒ©ãƒƒã‚·ãƒ¥ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸  
  
- è¨˜äº‹ã®å…¬é–‹äºˆå®šæ—¥ã‚’éå»ã«ã—ã¦ã€Œå…¬é–‹ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã™ã¨  
ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãŒã€Œå…¬é–‹ã€+ã€Œå…¬é–‹ã«ã—ã¾ã—ãŸã€ã®ãƒ•ãƒ©ãƒƒã‚·ãƒ¥ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸  
    
- ã“ã®å¤‰æ›´ã‚’ï¼‘æ™‚é–“æ¯ã«è‡ªå‹•ã§ã‚‚è¡Œã†ã€‚
 
ã«ãªã‚‹ã‚ˆã†ã«å®Ÿè£…ã™ã‚‹ã€‚
***

# ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’è¿½åŠ ã™ã‚‹
ç¾çŠ¶ã€è¨˜äº‹ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã¯ã€Œä¸‹æ›¸ãã€ã¨ã€Œå…¬é–‹ã€ã®äºŒç¨®é¡ãªã®ã§ã€Œå…¬é–‹å¾…ã¡ã€ã¨ã„ã†ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’è¿½åŠ ã™ã‚‹ã€‚
~~~
[app/models/article.rb]

enum state: { draft: 0, published: 1 }
â†“
enum state: { draft: 0, published: 1, publish_wait: 2 }
~~~
âš ï¸ enumã«æ–°è¦ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’åŠ ãˆã‚‹æ™‚ã¯ã€å¿…ãšå³å´ã«å¢—ã‚„ã™ã€‚    
(0ã‚„1ã¨ã—ã¦æ–°æœŸã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å…¥ã‚Œã‚‹ã¨ã€æ—¢å­˜ã®è¨˜äº‹ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãŒå¤‰ã‚ã£ã¦ã—ã¾ã†ãŸã‚ã€‚)
***

# scopeã®è¿½åŠ 
å…¬é–‹æ—¥æ™‚ãŒç¾åœ¨ã‹ã‚‰è¦‹ã¦éå»ã®è¨˜äº‹ã‚’å–å¾—ã™ã‚‹ [scope](https://github.com/Tarara33/TIL/blob/main/Rails/Model/%E3%83%A1%E3%83%A2/scope.md)ã‚’ãƒ¢ãƒ‡ãƒ«ã«è¨­å®šã™ã‚‹ã€‚
~~~
[app/models/article.rb]

scope :past_published -> { where('published_at <= ?', Time.current) }
~~~
articleãƒ¢ãƒ‡ãƒ«ã«å®šç¾©ã•ã‚Œã¦ã‚‹ published_atã‚«ãƒ©ãƒ (å…¬é–‹æ—¥æ™‚ã®ã‚«ãƒ©ãƒ )ãŒã€  
Time.current(ç¾åœ¨æ™‚åˆ»)ã‚ˆã‚Šã‚‚éå»(<= çŸ¢å°ã˜ã‚ƒãªãã¦ä¸ç­‰å·)ã®ã‚‚ã®ã‚’ whereã§æ¢ã™ã€‚
***

# Rakeã‚¿ã‚¹ã‚¯ã®ä½œæˆ
Rakeã‚¿ã‚¹ã‚¯ã«ã¤ã„ã¦ã¯[ã‚³ãƒãƒ©](https://github.com/Tarara33/TIL/blob/main/Rails/%E6%A9%9F%E8%83%BD/Rake%E3%82%BF%E3%82%B9%E3%82%AF/Rake%E3%82%BF%E3%82%B9%E3%82%AF.md)
~~~
[lib/tasks/article_state.rake]

namespace :article_state do
  desc 'å…¬é–‹å¾…ã¡ã®ä¸­ã§ã€å…¬é–‹æ—¥æ™‚ãŒéå»ã«ãªã£ã¦ã„ã‚‹ã‚‚ã®ãŒã‚ã‚Œã°ã€ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’ã€Œå…¬é–‹ã€ã«å¤‰æ›´ã™ã‚‹ã€‚'
  task change_to_be_published: :environment do
    Article.ğŸ©µpublish_wait.ğŸ’špast_published.ğŸ’™find_eachğŸ§¡(&:published!)
  end
end
~~~
ğŸ©µ publish_wait  
å…ˆã»ã© articleãƒ¢ãƒ‡ãƒ«ã® enumã«è¿½åŠ ã—ãŸã€Œå…¬é–‹å¾…ã¡ã€ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹  
  
ğŸ’š past_published  
å…ˆã»ã© articleãƒ¢ãƒ‡ãƒ«ã«è¿½åŠ ã—ãŸ scope  
  
ğŸ’™ find_each(&:published!)  
find_eachã¯åˆ†å‰²ã—ã¦ãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’å–å¾—ã™ã‚‹ã€‚      
è©³ã—ãã¯[ã‚³ãƒãƒ©](https://github.com/Tarara33/TIL/blob/main/Rails/%E3%83%87%E3%83%BC%E3%82%BF%E3%83%BC/%E3%83%A1%E3%83%A2%E3%83%AA.md)        
  
ğŸ§¡ (&:published!)  
ã€Œ&:ã€ã¯é…åˆ—(find_eachã‚„mapã€selectã€pluckãªã©)ã®ä¸­èº«ã‚’å—ã‘å–ã‚‹ã‚ˆã†ãªãƒ¡ã‚½ãƒƒãƒ‰ã§ä½¿ç”¨ã™ã‚‹ã“ã¨ãŒã§ãã‚‹ã€‚
ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’ã€Œpublishedã€ã«å¤‰æ›´ã™ã‚‹ã€‚  
ã€Œï¼ã€ã¤ã„ã¦ã‚‹ã®ã§ã‚¨ãƒ©ãƒ¼å‡ºãŸã‚‰ä¾‹å¤–å‡ºã™ã€‚  
~~~
#ã“ã®äºŒã¤ã®ã‚³ãƒ¼ãƒ‰ã¯åŒã˜æ„å‘³
Article.find_each(&:published!)
Article.find_each { |article| article.published! }
~~~
***

# wheneverã§è‡ªå‹•åŒ–ã®è¨­å®š
wheneverã«ã¤ã„ã¦ã¯[ã‚³ãƒãƒ©](https://github.com/Tarara33/TIL/blob/main/Rails/Gem/whenever.md)    
~~~
[config/schedule.rb]

# Rails.rootã‚’ä½¿ç”¨ã™ã‚‹ãŸã‚ã«å¿…è¦
require File.expand_path(File.dirname(__FILE__) + '/environment')

# cronã‚’å®Ÿè¡Œã™ã‚‹ç’°å¢ƒå¤‰æ•°
rails_env = ENV['RAILS_ENV'] || :development

# cronã‚’å®Ÿè¡Œã™ã‚‹ç’°å¢ƒå¤‰æ•°ã‚’ã‚»ãƒƒãƒˆ
set :environment, rails_env

# cronã®ãƒ­ã‚°ã®åãå‡ºã—å ´æ‰€
set :output, "#{Rails.root}/log/cron.log"

#1æ™‚é–“ã”ã¨ã«ï¼ˆ:hourï¼‰å®Ÿè¡Œã™ã‚‹å…ˆç¨‹è¨­å®šã—ãŸrakeã‚¿ã‚¹ã‚¯ã‚’è¨˜å…¥
every :hour do
  rake 'article_state:change_to_be_published'
end
~~~
***

#ã€€è¨˜äº‹ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã®åˆ¤å®šãƒ­ã‚¸ãƒƒã‚¯ã®è¿½åŠ 
~~~
[app/models/article.rb]

# å…¬é–‹æ™‚é–“ãŒéãã¦ã„ã‚‹ã‹
def publishable?
  Time.current >= published_at
end


#draft(ä¸‹æ›¸ã)ã§ã‚ã‚Œã°return
#å…¬é–‹æ™‚é–“ãŒéãã¦ã„ã‚Œã°å…¬é–‹ã€‚éãã¦ã„ãªã‘ã‚Œã°å…¬é–‹å¾…ã¡ã«ã™ã‚‹
def adjust_state
    return if draft?

    self.state = if publishable?
                    :published
                  else
                    :publish_wait
                  end
  end
~~~
***

## ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼ã®ç·¨é›†â‘ 
æ›´æ–°ãƒœã‚¿ãƒ³ã®æ–¹ã®ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ç·¨é›†
~~~
[app/controllers/admin/article_controller.rb]

def update
    authorize(@article)

    if @article.update(article_params)
      flash[:notice] = 'æ›´æ–°ã—ã¾ã—ãŸ'
      redirect_to edit_admin_article_path(@article.uuid)
    else
...ä»¥ä¸‹çœç•¥

--------------------------------------------------------
[ä¸Šè¨˜ã‚’ä¸‹è¨˜ã«ç·¨é›†]

def update
    authorize(@article)

    @article.ğŸ§¡assign_attributes(article_params)
    @article.ğŸ’›adjust_state
    if @article.ğŸ’šsave
      flash[:notice] = 'æ›´æ–°ã—ã¾ã—ãŸ'
      redirect_to edit_admin_article_path(@article.uuid)
    else
    #ä»¥ä¸‹çœç•¥
~~~
ğŸ§¡ assign_attributes[(å‚è€ƒ)](https://qiita.com/mmaumtjgj/items/f2cb5b9c689e1eb835b8)  
   ç‰¹å®šã® attributeã‚’å¤‰æ›´ã™ã‚‹ãŸã‚ã®ãƒ¡ã‚½ãƒƒãƒ‰ã€‚  
   DBã«ã¯ä¿å­˜ã•ã‚Œãªã„ã€‚  
   DBã«ä¿å­˜ã™ã‚‹å ´åˆã¯ saveã‚’å®Ÿè¡Œã™ã‚‹å¿…è¦ãŒã‚ã‚‹ã€‚  
  
ğŸ’› adjust_state  
å…ˆã»ã© articleãƒ¢ãƒ‡ãƒ«ã«å®šç¾©ã—ãŸãƒ¡ã‚½ãƒƒãƒ‰ã€‚
  
ğŸ’š assign_attributesã‚’ä½¿ã£ã¦ã‚‹ãŸã‚ saveã‚’å®Ÿè¡Œã™ã‚‹ã€‚
***

## ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼ã®ç·¨é›†â‘¡
ã‚³ãƒãƒ©ã®ãƒœã‚¿ãƒ³ã¯ã€ãƒ•ãƒ©ãƒƒã‚·ãƒ¥ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚‚å¤‰ãˆã‚‹å¿…è¦ãŒã‚ã‚‹ã®ã§ãƒ¡ã‚½ãƒƒãƒ‰å®šç¾©ã™ã‚‹ã€‚  
~~~
[app/models/article.rb]

def message_on_published
  if published?
    'è¨˜äº‹ã‚’å…¬é–‹ã—ã¾ã—ãŸ'
  elsif publish_wait?
    'è¨˜äº‹ã‚’å…¬é–‹å¾…ã¡ã«ã—ã¾ã—ãŸ'
  end
end
~~~
å…¬é–‹ãƒœã‚¿ãƒ³ã®æ–¹ã®ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ç·¨é›†ã€‚
~~~
[app/controllers/admin/articles/publishes_controller.rb]

def update
    â‘ @article.published_at = Time.current unless @article.published_at?
    â‘¡@article.state = :published

    if @article.valid?
      Article.transaction do
        @article.save!
      end

      flash[:notice] = 'è¨˜äº‹ã‚’å…¬é–‹ã—ã¾ã—ãŸ'

      redirect_to edit_admin_article_path(@article.uuid)
    else
...ä»¥ä¸‹çœç•¥

---------------------------------------------------------
[ä¸Šè¨˜ã‚’ä¸‹è¨˜ã«ç·¨é›†]

def update
    â‘ @article.published_at = Time.current unless @article.published_at?
    â‘¡@article.state = @article.publishable? ? :published : :publish_wait

    if @article.valid?
      Article.transaction do
        @article.save!
      end

      â‘¢flash[:notice] = @article.message_on_published

      redirect_to edit_admin_article_path(@article.uuid)
    else
~~~
â‘  article ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã® published_atå±æ€§ã«å¯¾ã—ã¦ã€  
  ã€€ãã®å€¤ãŒã¾ã è¨­å®šã•ã‚Œã¦ã„ãªã„å ´åˆã«ã€ç¾åœ¨ã®æ™‚åˆ» (Time.current) ã‚’è¨­å®šã™ã‚‹ãŸã‚ã®ã‚³ãƒ¼ãƒ‰ã€‚
    
â‘¡ @article ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã® state å±æ€§ã«å¯¾ã—ã¦å€¤ã‚’è¨­å®šã™ã‚‹ãŸã‚ã®ã‚³ãƒ¼ãƒ‰ã€‚    
  ã€€articleãƒ¢ãƒ‡ãƒ«ã«è¨­å®šã—ãŸãƒ¡ã‚½ãƒƒãƒ‰(publishable?)ã‚’ä½¿ã£ã¦ã€  
  ã€€trueãªã‚‰ stateå±æ€§ã« :publishedã¨ã„ã†å€¤ã‚’ã‚»ãƒƒãƒˆã—ã¦ã€ãã‚Œä»¥å¤–ã®å ´åˆã€:publish_wait ã¨ã„ã†å€¤ã‚’è¨­å®šã™ã‚‹ã€‚  
  
â‘¢ å…ˆã»ã© articleãƒ¢ãƒ‡ãƒ«ã«å®šç¾©ã—ãŸãƒ¡ã‚½ãƒƒãƒ‰ã‚’ä½¿ã£ã¦ãƒ•ãƒ©ãƒƒã‚·ãƒ¥ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å¤‰ãˆã¦ã‚‹ã€‚
***

# ãƒ“ãƒ¥ãƒ¼ã§ã®æ™‚é–“é¸æŠã®å¤‰æ›´
ã‚¿ã‚¹ã‚¯ãŒï¼‘æ™‚é–“æ¯ã«æ›´æ–°ã•ã‚Œã‚‹ã‚ˆã†ã«ãªã£ã¦ã‚‹ã®ã§ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚‚æ™‚é–“è¨­å®šã‚’æ™‚åŒºåˆ‡ã‚Šã§è¨­å®šã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹ã€‚
~~~
[app/assets/javascripts/admin.js]

format: 'YYYY-MM-DD HH:mm'
â†“
format: 'YYYY-MM-DD HH:00'
~~~
[![Image from Gyazo](https://i.gyazo.com/307360d58a11978a00c6d37a352546e5.png)](https://gyazo.com/307360d58a11978a00c6d37a352546e5)
[![Image from Gyazo](https://i.gyazo.com/c73f79f6e0ad66587b946c6da7800313.png)](https://gyazo.com/c73f79f6e0ad66587b946c6da7800313)
***

