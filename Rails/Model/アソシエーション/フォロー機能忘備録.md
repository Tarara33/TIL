# ãƒ•ã‚©ãƒ­ãƒ¼æ©Ÿèƒ½ã®ãƒ†ãƒ¼ãƒ–ãƒ«ã‚¢ã‚½ã‚·ã‚¨ãƒ¼ã‚·ãƒ§ãƒ³
Rails7ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ« 14ç« ã«ãŠã„ã¦ã®å¿˜å‚™éŒ²ã€‚
  
# ãƒ•ã‚©ãƒ­ãƒ¼æ©Ÿèƒ½ã®ãƒ†ãƒ¼ãƒ–ãƒ«é–¢ä¿‚
- ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ãŸãã•ã‚“ã®ä»–ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ãƒ•ã‚©ãƒ­ãƒ¼ã§ãã‚‹  
- ä»–ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‹ã‚‰ãƒ•ã‚©ãƒ­ãƒ¼ã•ã‚Œã‚‹
  
=> ä¸€å¯¾å¤šã®é–¢ä¿‚  
  
ã—ã‹ã—ã€ãƒ•ã‚©ãƒ­ãƒ¼é–¢ä¿‚ã¯ä¸€æ–¹çš„ãªå ´åˆãŒã‚ã‚‹(è‡ªåˆ†ã¯ãƒ•ã‚©ãƒ­ãƒ¼ã—ã¦ã„ã‚‹ãŒã€ç›¸æ‰‹ã‹ã‚‰ã¯ã•ã‚Œã¦ãªã„çŠ¶æ…‹ãªã©)ã®ã§ã€
- ãƒ•ã‚©ãƒ­ãƒ¼ã—ã¦ã„ã‚‹ãƒ†ãƒ¼ãƒ–ãƒ«  
- ãƒ•ã‚©ãƒ­ãƒ¼ã•ã‚Œã¦ã‚‹ãƒ†ãƒ¼ãƒ–ãƒ«
  
ãŒå¿…è¦ã€‚
***

# ä½œã£ãŸãƒ†ãƒ¼ãƒ–ãƒ«
Relationshipãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ä½œæˆã—ãŸã€‚
~~~
[schema.rb]

create_table "relationships", force: :cascade do |t|
    t.integer "follower_id"
    t.integer "followed_id"
    t.datetime "created_at", null: false
    t.datetime "updated_at", null: false
    t.index ["followed_id"], name: "index_relationships_on_followed_id"
    t.index ["follower_id", "followed_id"], name: "index_relationships_on_follower_id_and_followed_id", unique: true
    t.index ["follower_id"], name: "index_relationships_on_follower_id"
  end
~~~
***

### â“ ãªãœ referenceså‹ã˜ã‚ƒãªã„ï¼Ÿï¼Ÿ
ãã®ç†ç”±ã¯ã€referenceså‹ã¯è‡ªå‹•çš„ã«ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã¨å¤–éƒ¨ã‚­ãƒ¼åˆ¶ç´„ã‚’ä½œã‚‹ãŸã‚ã€  
`user:references`ã¨ã™ã‚‹ã¨ä¸‹è¨˜ã®ã‚ˆã†ãªã‚«ãƒ©ãƒ åã«ãªã‚‹ã€‚
~~~
t.references "user_id"
~~~
ä»Šå›ã®ã‚±ãƒ¼ã‚¹ã§ã¯ç‰¹å®šã®åå‰ï¼ˆfollower_idã¨followed_idï¼‰ã‚’ä½¿ã„ãŸã„ã®ã§ integerå‹ã—ã¦ã‚‹ã€‚
***

# ã‚¢ã‚½ã‚·ã‚¨ãƒ¼ã‚·ãƒ§ãƒ³
~~~
[app/models/user.rb]

ğŸ©µhas_many :active_relationships, class_name:  "Relationship",
                                foreign_key: "follower_id",
                                dependent:   :destroy
has_many :passive_relationships, class_name:  "Relationship",
                                 foreign_key: "followed_id",
                                 dependent:   :destroy
ğŸ’šhas_many :following, through: :active_relationships, source: :followed
has_many :followers, through: :passive_relationships, source: :follower


[app/models/relationships.rb]
class Relationship < ApplicationRecord
ã€€ğŸ§¡belongs_to :follower, class_name: "User"
  belongs_to :followed, class_name: "User"
end
~~~
#### â­ï¸ class_name
class_name ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã¯ã€é–¢é€£ã™ã‚‹ãƒ¢ãƒ‡ãƒ«ã®åå‰ã‚’æ˜ç¤ºçš„ã«æŒ‡å®šã™ã‚‹ãŸã‚ã«ä½¿ç”¨ã•ã‚Œã‚‹ã€‚
***

## ğŸ§¡
~~~
belongs_to :follower, class_name: "User"
belongs_to :followed, class_name: "User"
~~~
Userãƒ†ãƒ¼ãƒ–ãƒ«ã® id(é€šå¸¸ user_id)ã‚’ã€Œfollower_idã€ã¨ã€Œfollowed_idã€ã¨ã„ã†åå‰ã§å‚ç…§ã™ã‚‹æŒ‡å®šã‚’ã—ã¦ã„ã‚‹ã€‚    
ãªã®ã§ã€ã€Œfollowerã€ã¨ã€Œfollowedã€ã¨ã„ã†åå‰ã§ Userã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’å‚ç…§ã§ãã‚‹ã‚ˆã†ã«ãªã£ã¦ã„ã‚‹ã€‚
***

## ğŸ©µ
~~~
has_many :active_relationships, class_name:  "Relationship",
                                foreign_key: "follower_id",
                                dependent:   :destroy
~~~
ã€Œactive_relationshipsã€ã¨ã„ã†åå‰ã§ Relationshipãƒ†ãƒ¼ãƒ–ãƒ«ã‚’å‚ç…§ã—ã¦ã€  
å¤–éƒ¨ã‚­ãƒ¼ã‚’ã€Œfollower_idã€ã«è¨­å®šã—ã¦ã„ã‚‹ã€‚  
    
ğŸ§¡ ã§å®šç¾©ã—ãŸ follower_id(user_id)ã¨ Relationshipãƒ†ãƒ¼ãƒ–ãƒ«ã®(follower_id)ã‚’ãã£ã¤ã‘ã‚‹ã‹ã‚“ã˜ã€‚  
  
ã€Œpassive_relationshipsã€ã®æ–¹ã‚‚åŒã˜ã‹ã‚“ã˜ã€‚
***

## ğŸ’š
~~~
has_many :following, through: :active_relationships, source: :followed
~~~
has_many :followingã¯ã€ã€Œè‡ªåˆ†ã€ãŒã€Œå¤šæ•°ã®ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ã€Œãƒ•ã‚©ãƒ­ãƒ¼ã—ã¦ã„ã‚‹ã€ã¨ã„ã†é–¢ä¿‚ã‚’å®šç¾©ã™ã‚‹ã€‚    
through: :active_relationshipsã§ã€ãã®é–¢ä¿‚ãŒ active_relationshipsãƒ†ãƒ¼ãƒ–ãƒ«ã‚’é€šã˜ã¦æˆã‚Šç«‹ã£ã¦ã„ã‚‹ã“ã¨ã‚’ç¤ºã—ã¦ã„ã‚‹ã€‚  
æ›´ã«ã€source: :followedã¯ã€active_relationshipsãƒ†ãƒ¼ãƒ–ãƒ«ã® followed_idã‚’å‚ç…§ã™ã‚‹ã“ã¨ã§ã€  
ã€Œè‡ªåˆ†ãŒãƒ•ã‚©ãƒ­ãƒ¼ã—ã¦ã„ã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼ã€ã‚’å–å¾—ã™ã‚‹ã“ã¨ãŒã§ãã‚‹ã€‚
***

## ğŸ’¡ ä¸€ã¤ã®ãƒ†ãƒ¼ãƒ–ãƒ«ã‹ã‚‰äºŒã¤ã®ä¸­é–“ãƒ†ãƒ¼ãƒ–ãƒ«
ä»Šå›ã€€Relationship(é–¢ä¿‚)ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ä½œã£ãŸã€‚   
ã‚¢ã‚½ã‚·ã‚¨ãƒ¼ã‚·ãƒ§ãƒ³ã§äºŒã¤ã®é–¢ä¿‚æ€§ã‚’å®šç¾©ã—ãŸã®ã§ã€ãƒ†ãƒ¼ãƒ–ãƒ«ãŒä¸€ã¤ã§ã‚‚ 
- ãƒ•ã‚©ãƒ­ãƒ¼ã—ã¦ã„ã‚‹ãƒ†ãƒ¼ãƒ–ãƒ«  
- ãƒ•ã‚©ãƒ­ãƒ¼ã•ã‚Œã¦ã‚‹ãƒ†ãƒ¼ãƒ–ãƒ«

ã¨ã—ã¦äºŒã¤ã®ãƒ†ãƒ¼ãƒ–ãƒ«ãŒã§ããŸã€‚
***

## â“ ã„ã¤ã‚‚ã®ã‚¢ã‚½ã‚·ã‚¨ãƒ¼ã‚·ãƒ§ãƒ³ã§ã¯ãƒ€ãƒ¡ï¼Ÿï¼Ÿ
~~~
has_many :active_relationships, class_name:  "Relationship",
                                foreign_key: "follower_id",
                                dependent:   :destroy

â†“

has_many :relationships
has_many :active_relationships, through: :relationships, dependent: :destroy
~~~
ã“ã‚Œã‚‰ã®ã‚³ãƒ¼ãƒ‰ã¯å…¨ãç•°ãªã‚‹æ„å‘³ã‚’æŒã¤ã€‚
~~~
æœ€åˆã® has_many :active_relationshipsã¯ã€  
ã€Œè‡ªåˆ†ã€ãŒã€Œå¤šæ•°ã® active_relationshipsã€ã‚’æŒã£ã¦ã„ã‚‹ã¨ã„ã†é–¢ä¿‚ã‚’å®šç¾©ã—ã€ã€ŒRelationshipã€ãƒ¢ãƒ‡ãƒ«ã‚’å‚ç…§ã—ã¦ã„ã‚‹ã€‚  
è‡ªåˆ†ã® idãŒ Relationshipãƒ†ãƒ¼ãƒ–ãƒ«ã® follower_idã¨ä¸€è‡´ã™ã‚‹ã‚‚ã®ã‚’å–å¾—ã™ã‚‹ã¤ã¾ã‚Šã€ã€Œè‡ªåˆ†ãŒãƒ•ã‚©ãƒ­ãƒ¼ã—ã¦ã„ã‚‹ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚·ãƒƒãƒ—ã€ã‚’å–å¾—ã§ãã‚‹ã€‚  
  
ä¸€æ–¹ã€has_many :relationshipsã¨ has_many :active_relationships, through: :relationships, dependent: :destroyã¯ã€  
ä¸­é–“ãƒ†ãƒ¼ãƒ–ãƒ« :relationshipsã‚’çµŒç”±ã—ã¦ active_relationshipsã‚’å–å¾—ã—ã‚ˆã†ã¨ã—ã¦ã„ã‚‹ã€‚  
ã“ã“ã§ã® :active_relationshipsã¯ä¸­é–“ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’çµŒç”±ã—ã¦å–å¾—ã™ã‚‹é–¢é€£ä»˜ã‘ãªã®ã§ã€å…·ä½“çš„ãªãƒ¢ãƒ‡ãƒ«ã®åå‰ã‚„ã‚­ãƒ¼ãŒå¿…è¦ã«ãªã‚‹ã€‚ (active_relationshipsãƒ†ãƒ¼ãƒ–ãƒ«ãŒå¿…è¦ï¼‰ 
ã“ã®è¨­å®šã ã¨ active_relationshipsã¯ã©ã®ãƒ¢ãƒ‡ãƒ«ã‚’å‚ç…§ã™ã¹ãã‹åˆ†ã‹ã‚‰ãªã„ã€‚
~~~
***

