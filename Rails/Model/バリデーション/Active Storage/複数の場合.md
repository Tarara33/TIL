# è¤‡æ•°æšã®å ´åˆã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
[ã‚³ãƒãƒ©](https://github.com/Tarara33/TIL/blob/main/Rails/Model/%E3%83%90%E3%83%AA%E3%83%87%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3/Active%20Storage/%E4%B8%80%E6%9E%9A%E3%81%AE%E5%A0%B4%E5%90%88.md)ã§å®Ÿè£…ã—ãŸã‚«ã‚¹ã‚¿ãƒ ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ãŒè¤‡æ•°æšã®å ´åˆå°‘ã—å¤‰ã‚ã‚‹ã€‚
***

# ãƒ¢ãƒ‡ãƒ«ã«ã‹ããƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
~~~
[app/models/article.rb]

has_many_attached :eye_catchs
validates :eye_catchs, attachment: { purge: true, content_type: %r{\Aimage/(png|jpeg)\Z}, maximum: 10_485_760 }
~~~
***

# ã‚«ã‚¹ã‚¿ãƒ ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
äºŒç®‡æ‰€ã»ã©å¤‰ã‚ã‚‹ã€‚    
ç°¡å˜ã«è¨€ã†ã¨ã€è¤‡æ•°ã ã£ãŸã‚‰ ifæ–‡ã®ãªã‹ã®å‡¦ç†ã‚’ã—ã¦ã€ä¸€æšã ã£ãŸã‚‰ elseæ–‡ã®å‡¦ç†ã‚’ã™ã‚‹ã®ã§ã€  
ä¸€æšã§ã‚‚è¤‡æ•°ã§ã‚‚å…±æœ‰ã§ãã‚‹ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã§ã‚ã‚‹ã€‚
~~~
[app/validators/attachment_validator.rb]


class AttachmentValidator < ActiveModel::EachValidator
  include ActiveSupport::NumberHelper

  def validate_each(record, attribute, value)
    return if value.blank? || !value.attached?

    has_error = false

    ğŸŒif options[:maximum]
      if value.is_a?(ActiveStorage::Attached::Many)
        value.each do |v|
          unless validate_maximum(record, attribute, v)
            has_error = true
            break
          end
        end
      else
        has_error = true unless validate_maximum(record, attribute, value)
      end
    end

    ğŸŒif options[:content_type]
      if value.is_a?(ActiveStorage::Attached::Many)
        value.each do |v|
          unless validate_content_type(record, attribute, v)
            has_error = true
            break
          end
        end
      else
        has_error = true unless validate_content_type(record, attribute, value)
      end
    end

    record.send(attribute).purge if options[:purge] && has_error
  end

  private

  def validate_maximum(record, attribute, value)
    if value.byte_size > options[:maximum]
      record.errors[attribute] << (options[:message] || "ã¯#{number_to_human_size(options[:maximum])}ä»¥ä¸‹ã«ã—ã¦ãã ã•ã„")
      false
    else
      true
    end
  end

  def validate_content_type(record, attribute, value)
    if value.content_type.match?(options[:content_type])
      true
    else
      record.errors[attribute] << (options[:message] || 'ã¯å¯¾å¿œã§ããªã„ãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼ã§ã™')
      false
    end
  end
end
~~~
***

# ç´°ã‹ãè¦‹ã¦ã¿ã‚‹
~~~
if options[:maximum]
  if value.is_a?(ActiveStorage::Attached::Many)
    value.each do |v|
      unless validate_maximum(record, attribute, v)
        has_error = true
        break
      end
    end
  else
    has_error = true unless validate_maximum(record, attribute, value)
  end
end
~~~
  
ã‚‚ã—ã€æ¤œç´¢å¯¾è±¡(value)ã®å±ã—ã¦ã„ã‚‹ã‚¯ãƒ©ã‚¹ãŒ ActiveStorage::Attached::Manyãªã‚‰ã€  
eachæ–‡ã§ãã‚Œãã‚Œ validate_maximumãƒ¡ã‚½ãƒƒãƒ‰ã§æ¤œè¨¼ã—ã¦ã€  
ã‚‚ã— has_errorãŒ trueã«ãªã£ãŸæ™‚ç‚¹ã§ breakã§ãƒ«ãƒ¼ãƒ—ã‚’æŠœã‘ã‚‹ã€‚

ActiveStorage::Attached::Manyã‚¯ãƒ©ã‚¹ã˜ã‚ƒãªã„ãªã‚‰ elseã§ä¸€æšã ã‘ã®æ¤œè¨¼ã™ã‚‹ã€‚
***

#### â­ï¸ is_a?
ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒæŒ‡å®šã•ã‚ŒãŸã‚¯ãƒ©ã‚¹ã¾ãŸã¯ãã®ã‚µãƒ–ã‚¯ãƒ©ã‚¹ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã§ã‚ã‚‹ã‹ã©ã†ã‹ã‚’ç¢ºèªã™ã‚‹ãŸã‚ã«ä½¿ç”¨ã•ã‚Œã‚‹ãƒ¡ã‚½ãƒƒãƒ‰ã€‚
~~~
string = "Hello, World!"
string.is_a?(String)
=> true
~~~
***

#### â­ï¸ ActiveStorage::Attached::Many
Active Storageãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ä½¿ç”¨ã—ã¦è¤‡æ•°ã®ã‚¢ã‚¿ãƒƒãƒãƒ¡ãƒ³ãƒˆï¼ˆãƒ•ã‚¡ã‚¤ãƒ«æ·»ä»˜ï¼‰ã‚’ç®¡ç†ã™ã‚‹ãŸã‚ã«ä½¿ç”¨ã•ã‚Œã‚‹ã‚¯ãƒ©ã‚¹ã€‚  
ä¸€æšã®å ´åˆã¯ ActiveStorage::Attachedã‚¯ãƒ©ã‚¹ã€‚  
***  
