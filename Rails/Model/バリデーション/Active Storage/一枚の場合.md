[å‚è€ƒ](https://qiita.com/ken1flan/items/76dcdd4971d26b4fb13d#%E3%82%B3%E3%83%BC%E3%83%89-3)  
[Gemä½¿ã£ãŸå ´åˆ](https://github.com/Tarara33/TIL/blob/main/Rails/Gem/active_storage_validations.md)  
    
# Active Storageã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
[Active Storage](https://github.com/Tarara33/TIL/blob/main/Rails/%E6%A9%9F%E8%83%BD/Active%20Storage.md)ã‚„ Paperclipãªã©ã«ãŠã„ã¦ã€ãƒ•ã‚¡ã‚¤ãƒ«æ·»ä»˜å±æ€§ã«é–¢é€£ã™ã‚‹ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’è¨­å®šã™ã‚‹å ´åˆ
~~~
validates :ãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚«ãƒ©ãƒ å, attachment: { ã‚ªãƒ—ã‚·ãƒ§ãƒ³å†…å®¹ }
~~~
` attachment: { ã‚ªãƒ—ã‚·ãƒ§ãƒ³å†…å®¹ }`ã¨ã„ã†æ§‹æ–‡ã‚’ä½¿ã†ã€‚
***

## å®Ÿè£…ä¾‹
~~~
[app/models/article.rb]

has_one_attached :eye_catch
validates :eye_catch, attachment: { purge: true, content_type: %r{\Aimage/(png|jpeg)\Z}, maximum: 10_485_760 }
~~~

### â­ï¸ purge
ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’é€šéã—ãªã‹ã£ãŸå ´åˆã«ãƒ•ã‚¡ã‚¤ãƒ«ã‚’è‡ªå‹•çš„ã«å‰Šé™¤ã™ã‚‹ãŸã‚ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã€‚  
ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã«åˆæ ¼ã—ãªã„ãƒ•ã‚¡ã‚¤ãƒ«ã¯è‡ªå‹•çš„ã«å‰Šé™¤ã•ã‚Œã‚‹ã€‚  

### â­ï¸ content_type
ãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚¿ã‚¤ãƒ—ã‚’æ¤œè¨¼ã™ã‚‹ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã€‚

### â­ï¸ maximum
ã“ã“ã§ã® maximumã¯ãƒ•ã‚¡ã‚¤ãƒ«ã®æœ€å¤§ã‚µã‚¤ã‚ºã‚’ãƒã‚¤ãƒˆå˜ä½ã§æŒ‡å®šã—ã¦ã„ã‚‹ã€‚  
ã“ã“ã§ã¯ç´„ 10MBï¼ˆ10,485,760ãƒã‚¤ãƒˆï¼‰ã‚’è¨­å®šã—ã€è¶…ãˆã‚Œã°ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã«å¼•ã£ã‹ã‹ã‚‹ã€‚
  
âš ï¸ `attachment:{}`ã®ä¸­èº«ã¯ã‚ªãƒ—ã‚·ãƒ§ãƒ³ãªã®ã§ã‚³ãƒ¬ã‚‰ã¯å…¨ã¦ãƒ¡ã‚½ãƒƒãƒ‰ã§ã¯ãªãã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼
***

### ã¡ãªã¿ã«...
~~~
validates :eye_catch, attachment: { purge: true, content_type: %r{\Aimage/(png|jpeg)\Z}, maximum: 10_485_760 }
~~~
~~~
validates :eye_catch, attached: true, content_type: %r{\Aimage/(png|jpeg)\Z}, size: { less_than: 10.megabytes }
~~~
ã“ã®äºŒã¤ã®ã‚³ãƒ¼ãƒ‰ã¯ã€ã»ã¼åŒã˜æ„å‘³(?)  
â€» purgeã¯ Active Storageã®ãƒ¡ã‚½ãƒƒãƒ‰ãªã®ã§ç„¡åŠ¹ã«ãªã‚‹ã€‚ã‚‰ã—ã„ã€‚

### â­ï¸ attached
ãƒ•ã‚¡ã‚¤ãƒ«ãŒæ·»ä»˜ã•ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèªã™ã‚‹ã€‚

# ã‚«ã‚¹ã‚¿ãƒ ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚‚è¿½åŠ ã™ã‚‹å ´åˆ    
å…ˆã»ã©ãƒ¢ãƒ‡ãƒ«ã§å®šç¾©ã—ãŸãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã§åˆ¶é™ã‹ã‹ã‚‹ãŒã€    
ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºã‚„ã€ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³å¤±æ•—æ™‚ã®å‡¦ç†ãªã©ã€ã‚ˆã‚Šç´°ã‹ã„åˆ¶å¾¡ã‚’è¡Œã„ãŸã„å ´åˆã¯ã€ã‚«ã‚¹ã‚¿ãƒ ãƒãƒªãƒ‡ãƒ¼ã‚¿ãŒå¿…è¦ã€‚  
  
âš ï¸ ã‚«ã‚¹ã‚¿ãƒ ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ã¯æ‰‹å‹•ã§ä½œæˆ(`æ¤œè¨¼å_validator.rb`ã¤ã‘ã‚‹ã®å¿˜ã‚Œãšã«)
~~~
ä¾‹
[app/validators/attachment_validator.rb]

â‘ class AttachmentValidator < ActiveModel::EachValidator
  â‘¡include ActiveSupport::NumberHelper

  â‘¢def validate_each(record, attribute, value)
    return if value.blank? || !value.attached?

    â‘£has_error = false

    â‘¤if options[:maximum]
      has_error = true unless validate_maximum(record, attribute, value)
    end

    â‘¥if options[:content_type]
      has_error = true unless validate_content_type(record, attribute, value)
    end

    â‘¦record.send(attribute).purge if options[:purge] && has_error
  end

  private

  def validate_maximum(record, attribute, value)
    if value.byte_size > options[:maximum]
      â‘§record.errors[attribute] << (options[:message] || "ã¯#{number_to_human_size(options[:maximum])}ä»¥ä¸‹ã«ã—ã¦ãã ã•ã„")
      ğŸ©µfalse
    else
      ğŸ’štrue
    end
  end

  def validate_content_type(record, attribute, value)
    if value.content_type.match?(options[:content_type])
      true
    else
      record.errors[attribute] << (options[:message] || 'ã¯å¯¾å¿œã§ããªã„ãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼ã§ã™')
      false
    end
  end
end
~~~
***

## â‘  ActiveModel::EachValidator
1ã¤ã®å±æ€§ã‚’æ¤œè¨¼ã™ã‚‹ãŸã‚ã®æ–°ã—ã„ãƒãƒªãƒ‡ãƒ¼ã‚¿ã‚’è¿½åŠ ã—ãŸã„å ´åˆã¯ ActiveModel::EachValidatorã‚’ç¶™æ‰¿ã—ãŸã‚¯ãƒ©ã‚¹ã‚’å®šç¾©ã™ã‚‹ã€‚    
ä»Šå›ã«é–¢ã—ã¦ã¯ã€Œ:eye_catchã€å±æ€§ã‚’æ¤œè¨¼ã—ã¦ã‚‹ã€‚  

- ã‚¯ãƒ©ã‚¹åã¯<æ¤œè¨¼å>Validatorã®å½¢å¼ã§å‘½åã€‚
- validate_eachãƒ¡ã‚½ãƒƒãƒ‰ã‚’å®Ÿè£…ã™ã‚‹å¿…è¦ãŒã‚ã‚‹ã€‚
***

## â‘¡ ActiveSupport::NumberHelper
ã‚µãƒãƒ¼ãƒˆãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®ä¸€ã¤ã€‚  
æ•°å€¤ã‚’é€šè²¨å½¢å¼ã«ã—ã¦ãã‚ŒãŸã‚Šã€æ•°å€¤ã®æ¡ã‚’åŒºåˆ‡ã£ã¦ãã‚ŒãŸã‚Šã™ã‚‹ã€‚
***

## â‘¢ validate_each(record, attribute, value)
ã“ã®ã€ŒActiveModel::EachValidatorã€ã‚’ç¶™æ‰¿ã—ãŸã‚¯ãƒ©ã‚¹å†…ã§å®Ÿè£…ã™ã‚‹å¿…è¦ãŒã‚ã‚‹ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’è¡Œã†ãŸã‚ã®ãƒ¡ã‚½ãƒƒãƒ‰ã€‚
    
- record...æ¤œè¨¼å¯¾è±¡ã®ãƒ¢ãƒ‡ãƒ«ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹  
- attribute...æ¤œè¨¼å¯¾è±¡ã®å±æ€§å  
- value...æ¤œè¨¼å¯¾è±¡ã®å±æ€§å€¤  

ã—ã‹ã—ã€ã‚‚ã— valueãŒç©ºã‹ãƒ•ã‚¡ã‚¤ãƒ«ã®æ·»ä»˜ãŒãªã„å ´åˆã¯ returnã§ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚¹ã‚­ãƒƒãƒ—ã—ã¦ã‚‹ã€‚
***

### ç¢ºèªã—ã¦ã¿ã‚‹
ã“ã®è¨˜äº‹ã§ record, attribute, valueãã‚Œãã‚Œä½•ãŒå…¥ã£ã¦ã‚‹ã®ã‹ç¢ºèªã—ã¦ã¿ã‚‹ã€‚[(å‚è€ƒ)](https://blog.cloud-acct.com/posts/u-rails-custom-eachvalidator/#%E4%BB%AE%E3%83%A6%E3%83%BC%E3%82%B6%E3%83%BC%E3%81%AE%E4%BF%9D%E5%AD%98)    
[![Image from Gyazo](https://i.gyazo.com/7379be1a4b6ac442036cb38de9317545.png)](https://gyazo.com/7379be1a4b6ac442036cb38de9317545)  
    
~~~
def validate_each(record, attribute, value)
    binding.pry
~~~
~~~
[rails c]

[1] pry(#<AttachmentValidator>)> record
=> #<Article:0x000000010b7c26b0
 id: 5,
 category_id: 9,
 author_id: 4,
 uuid: "bf823b2e-76a4-45ef-a87e-a6774df3147e",
 slug: "w",
 title: "ruby on rails",
 description: "ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—",
 body: "<p>ruby on rails</p>",
 state: "published",
 published_at: Mon, 28 Aug 2023 22:00:00 JST +09:00,
 created_at: Fri, 25 Aug 2023 16:16:28 JST +09:00,
 updated_at: Tue, 29 Aug 2023 03:22:23 JST +09:00,
 deleted_at: nil,
 eyecatch_width: 100,
 eyecatch_align: "center">

[2] pry(#<AttachmentValidator>)> attributes
=> [:eye_catch]

[3] pry(#<AttachmentValidator>)> value
=> #<ActiveStorage::Attached::One:0x000000010c0ae058
 @dependent=:purge_later,
 @name="eye_catch",
 @record=
  #<Article:0x000000010b7c26b0
   id: 5,
   category_id: 9,
   author_id: 4,
   uuid: "bf823b2e-76a4-45ef-a87e-a6774df3147e",
   slug: "w",
   title: "ruby on rails",
   description: "ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—",
   body: "<p>ruby on rails</p>",
   state: "published",
   published_at: Mon, 28 Aug 2023 22:00:00 JST +09:00,
   created_at: Fri, 25 Aug 2023 16:16:28 JST +09:00,
   updated_at: Tue, 29 Aug 2023 03:22:23 JST +09:00,
   deleted_at: nil,
   eyecatch_width: 100,
   eyecatch_align: "center">>

~~~
***

## â‘£ has_error = false
ã“ã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ãƒ¡ã‚½ãƒƒãƒ‰å†…ã§ã‚¨ãƒ©ãƒ¼ã®æœ‰ç„¡ã‚’ãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°ã™ã‚‹ãŸã‚ã®å¤‰æ•°ã€‚
ã“ã®å¤‰æ•°ã¯åˆæœŸå€¤ã¨ã—ã¦ falseã§åˆæœŸåŒ–ã—ã¦ãŠãã€‚  
  
â‘¤ãƒ»â‘¥ã®å‡¦ç†ã‚’è¡Œã„ã€æœ€çµ‚çš„ã« trueã«å¤‰ã‚ã£ãŸã‚‰ã€â‘¥ã®å‡¦ç†ã‚’è¡Œã†ã€‚
***

## â‘¤ãƒ»â‘¥ options[:maximum] / options[:content_type]
ã“ã® optionsã«ã¯ä»¥ä¸‹ã®ã‚³ãƒ¼ãƒ‰ã§å®šç¾©ã•ã‚ŒãŸåŒåã®ã‚­ãƒ¼ã®å€¤ãŒæ ¼ç´ã•ã‚Œã¦ã‚‹ã€‚    
ğŸ’¡ `attachment:{}`ã®ä¸­èº«ã¯ã‚ªãƒ—ã‚·ãƒ§ãƒ³ãŒæ›¸ã‹ã‚Œã¦ã„ã‚‹ã®ã§ã€`options[]`ã§èª­ã¿å–ã£ã¦ã„ã‚‹ï¼ 
~~~
[app/models/article.rb]

validates :eye_catch, attachment: { purge: true, content_type: %r{\Aimage/(png|jpeg)\Z}, maximum: 10_485_760 }
~~~
- [:maximum]ã¯ maximumã®æœ€å¤§å€¤ã€Œ10_485_760ã€ãŒæ ¼ç´ã•ã‚Œã¦ã‚‹ã€‚    
- [:content_type]ã¯ã€Œ%r{\Aimage/(png|jpeg)\Z}ã€ãŒæ ¼ç´ã•ã‚Œã¦ã‚‹ã€‚  
***

~~~
if options[:maximum]
  has_error = true unless validate_maximum(record, attribute, value)
end

if options[:content_type]
  has_error = true unless validate_content_type(record, attribute, value)
end
~~~
ãã—ã¦ãã‚Œãã‚Œã€ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆãƒ¡ã‚½ãƒƒãƒ‰ãŒã€€falseãŒè¿”ã£ã¦ããŸã‚‰(unlessã ã‹ã‚‰)ã€å¤‰æ•° has_errorãŒ trueã«å¤‰ã‚ã‚‹ã€‚
***

## â‘¦ record.send(attribute).purge
~~~
record.send(attribute).purge if options[:purge] && has_error
~~~
ã“ã®ã‚³ãƒ¼ãƒ‰ã® recordã¨ã€attributeã«ã¯ validate_eachã§å¼•æ•°ã§å—ã‘å–ã£ãŸå€¤ãŸã¡ãŒå…¥ã£ã¦ã‚‹ã€‚  
  
ã‚‚ã—ã€options[:purge]ãŒ true ã‹ã¤ å¤‰æ•° has_errorã‚‚ trueãªã‚‰  
attribute(:eye_catch)ãŒæŒã¤ãƒ¡ã‚½ãƒƒãƒ‰ purgeã‚’å‘¼ã³å‡ºã™ã€‚  

### â­ï¸ send
ãƒ¬ã‚·ãƒ¼ãƒã®æŒã£ã¦ã„ã‚‹ãƒ¡ã‚½ãƒƒãƒ‰ã‚’å‘¼ã³å‡ºã—ã¦ãã‚Œã‚‹ãƒ¡ã‚½ãƒƒãƒ‰
***

## â‘§ record.errors[attribute]
ç‰¹å®šã®å±æ€§ï¼ˆattributeï¼‰ã«é–¢é€£ä»˜ã‘ã‚‰ã‚ŒãŸã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æ ¼ç´ã™ã‚‹ãŸã‚ã®ã‚¨ãƒ©ãƒ¼ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã€‚  
  
ä»Šå›ã®å ´åˆ :eye_catchã«ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒå…¥ã‚‹ã€‚  
options[:message]ãŒã‚ã‚Œã°ãã‚Œã‚’ã€ãªã‘ã‚Œã°å¾Œã‚ã®ã‚„ã¤ãŒå…¥ã‚‹ã€‚  
~~~
def validate_maximum(record, attribute, value)
    if value.byte_size > options[:maximum]
      â‘§record.errors[attribute] << (options[:message] || "ã¯#{number_to_human_size(options[:maximum])}ä»¥ä¸‹ã«ã—ã¦ãã ã•ã„")
      ğŸ©µfalse
    else
      ğŸ’štrue
    end
  end
~~~
ğŸ©µğŸ’š â‘¤ã®ã‚³ãƒ¼ãƒ‰ã§ã€€trueã€€or falseãŒå¿…è¦ãªã®ã§æ›¸ã„ã¦ã‚‹ã€‚
***
