# ãƒ†ã‚¹ãƒˆã®èª­ã¿æ–¹(åŸºæœ¬ç·¨)
~~~
[spec/system/tasks.rb]

require 'rails_helper'

RSpec.describe "Tasks", type: :system do
  describe 'ã‚¿ã‚¹ã‚¯ã®æ–°è¦ç™»éŒ²' do
    context 'ãƒ•ã‚©ãƒ¼ãƒ ã®å…¥åŠ›å€¤ãŒæ­£ã—ã„' do
      it 'æ–°è¦ä½œæˆãŒæˆåŠŸã™ã‚‹' do
        click_link 'New task'
        fill_in 'Title', with: 'ãƒ†ã‚¹ãƒˆ'
        fill_in 'Content', with: 'ãƒ†ã‚¹ãƒˆ'
        click_button 'Create Task'
        expect(page).to have_content "Title: ãƒ†ã‚¹ãƒˆ"
        expect(page).to have_content "Content: ãƒ†ã‚¹ãƒˆ"
        expect(current_path).to eq '/tasks/1'
      end
    end
~~~
***

## describe do~end
å¤§è¦‹å‡ºã—çš„ãªæ„Ÿã˜ã€‚    
ä¾‹ãˆã°ã€ã€Œãƒ­ã‚°ã‚¤ãƒ³å‰ã€ã‚„ã€Œãƒ­ã‚°ã‚¤ãƒ³å¾Œã€ã€ãƒ†ã‚¹ãƒˆã®å¯¾è±¡ãªã©ã€‚    
ï¼’å›ãã‚‰ã„é€£ç¶šã—ã¦ä½¿ã†ã“ã¨ã‚‚ã‚ã‚‹ã€‚(ã€Œãƒ­ã‚°ã‚¤ãƒ³å‰ã€ã®ã€Œã‚¿ã‚¹ã‚¯ã®æ–°è¦ç™»éŒ²ã€ã®ã‚ˆã†ãªæ„Ÿã˜ã§)
***

## context do~end
å°è¦‹å‡ºã—çš„ãªæ„Ÿã˜ã€‚    
ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ã‚’æ¡ä»¶ã”ã¨ã«ã¾ã¨ã‚ã‚‹ã®ã«ä½¿ã†ã“ã¨ãŒå¤šã„ã€‚    
ä¾‹ãˆã°ã€æ­£å¸¸ç³»ï¼Ÿç•°å¸¸ç³»ã‚„ã€ã€Œå…¥åŠ›å€¤ãŒæ­£ã—ã„ã€ã€ã€Œã‚¿ã‚¤ãƒˆãƒ«ãŒæœªå…¥åŠ›ã€ãªã©ã€‚    
***

## it do~end
æœŸå¾…ã™ã‚‹çµæœã‚’æ›¸ãã€‚
ã“ã®ä¸­ã« capybaraã®ãƒ¡ã‚½ãƒƒãƒ‰ãŸã¡(visitã¨ã‹)ã‚„ expectã‚’æ›¸ãã€‚
***

## expect
expectãƒ¡ã‚½ãƒƒãƒ‰ã¯ãƒ†ã‚¹ãƒˆå¯¾è±¡ã‚’æ¤œè¨¼ã™ã‚‹ãŸã‚ã®ãƒ¡ã‚½ãƒƒãƒ‰ã€‚
~~~
expect(å®Ÿè¡Œçµæœ).to eq æœŸå¾…ã™ã‚‹çµæœ
~~~
ãªã©ã¨æ›¸ãã€‚    
    
(å®Ÿè¡Œçµæœ)ã«ã¯    
- å¤‰æ•°    
- page    
- responce
    
ãªã©è‰²ã€…å…¥ã‚‹ã€‚

eqã®éƒ¨åˆ†ã¯[ãƒãƒƒãƒãƒ£ãƒ¼](https://github.com/Tarara33/TIL/blob/main/Rails/Test/RSpec/%E3%83%9E%E3%83%83%E3%83%81%E3%83%A3%E3%83%BC.md)ã¨å‘¼ã°ã‚Œã‚‹ã‚‚ã®ã€‚
***

# ãƒ†ã‚¹ãƒˆã®èª­ã¿æ–¹(å¿œç”¨ç·¨)
~~~
[spec/system/tasks.rb]

require 'rails_helper'

RSpec.describe "Tasks", type: :system do
  ğŸ§¡let(:user) {create(:user)}
  ğŸ’šlet(:task) {create(:task)}

  describe 'ãƒ­ã‚°ã‚¤ãƒ³å‰' do
    describe 'ãƒšãƒ¼ã‚¸é·ç§»ç¢ºèª' do
      context 'ã‚¿ã‚¹ã‚¯ã®æ–°è¦ä½œæˆãƒšãƒ¼ã‚¸ã«ã‚¢ã‚¯ã‚»ã‚¹' do
        it 'ã‚¢ã‚¯ã‚»ã‚¹å¤±æ•—' do
          visit new_task_path
          expect(current_path).to eq login_path
          expect(page).to have_content "Login required"
        end
      end

      context 'ã‚¿ã‚¹ã‚¯ã®ç·¨é›†ãƒšãƒ¼ã‚¸ã«ã‚¢ã‚¯ã‚»ã‚¹' do
        it 'ã‚¢ã‚¯ã‚»ã‚¹å¤±æ•—' do
          ğŸ’švisit edit_task_path(task)
          expect(current_path).to eq login_path
          expect(page).to have_content "Login required"
        end
      end

      context 'ã‚¿ã‚¹ã‚¯ã®è©³ç´°ãƒšãƒ¼ã‚¸ã«ã‚¢ã‚¯ã‚»ã‚¹' do
        it 'è¡¨ç¤ºã•ã‚Œã‚‹' do
          visit task_path(task)
          expect(current_path).to eq task_path(task)
          expect(page).to have_content task.title
        end
      end

      context 'ã‚¿ã‚¹ã‚¯ã®ä¸€è¦§ãƒšãƒ¼ã‚¸ã«ã‚¢ã‚¯ã‚»ã‚¹' do
        it 'è¡¨ç¤ºã•ã‚Œã‚‹' do
          visit tasks_path
          expect(current_path).to eq tasks_path
          expect(page).to have_content 'Tasks'
        end
      end
    end
  end


  describe 'ãƒ­ã‚°ã‚¤ãƒ³å¾Œ' do
    ğŸ§¡ğŸ©·before { login(user) }

    describe 'ã‚¿ã‚¹ã‚¯ã®æ–°è¦ç™»éŒ²' do
      context 'ãƒ•ã‚©ãƒ¼ãƒ ã®å…¥åŠ›å€¤ãŒæ­£ã—ã„' do
        it 'æ–°è¦ä½œæˆãŒæˆåŠŸã™ã‚‹' do
          click_link 'New task'
          fill_in 'Title', with: 'ãƒ†ã‚¹ãƒˆ'
          fill_in 'Content', with: 'ãƒ†ã‚¹ãƒˆ'
          click_button 'Create Task'
          expect(page).to have_content "Title: ãƒ†ã‚¹ãƒˆ"
          expect(page).to have_content "Content: ãƒ†ã‚¹ãƒˆ"
          expect(current_path).to eq '/tasks/1'
        end
      end

      context 'ã‚¿ã‚¤ãƒˆãƒ«ãŒæœªå…¥åŠ›' do
        it 'æ–°è¦ä½œæˆãŒå¤±æ•—ã™ã‚‹' do
          click_link 'New task'
          fill_in 'Title', with: ''
          fill_in 'Content', with: 'ãƒ†ã‚¹ãƒˆ'
          click_button 'Create Task'
          expect(page).to have_content "Title can't be blank"
          expect(current_path).to eq tasks_path
        end
      end

      context 'ç™»éŒ²æ¸ˆã¿ã®ã‚¿ã‚¤ãƒˆãƒ«ã‚’å…¥åŠ›' do
        it 'æ–°è¦ä½œæˆãŒå¤±æ•—ã™ã‚‹' do
          click_link 'New task'
          fill_in 'Title', with: task.title
          fill_in 'Content', with: 'ãƒ†ã‚¹ãƒˆ'
          click_button 'Create Task'
          expect(page).to have_content "Title has already been taken"
          expect(current_path).to eq tasks_path
        end
      end
    end

    describe 'ã‚¿ã‚¹ã‚¯ã®ç·¨é›†' do
     ğŸ©µlet!(:task) { create(:task, user: user) }
      let(:other_task) { create(:task, user: user) }
      ğŸ©µbefore { visit edit_task_path(task) }
      
      context 'ãƒ•ã‚©ãƒ¼ãƒ ã®å…¥åŠ›å€¤ãŒæ­£å¸¸' do
        it 'ã‚¿ã‚¹ã‚¯ã®ç·¨é›†ãŒæˆåŠŸã™ã‚‹' do
          fill_in 'Title', with: 'updated_title'
          select :done, from: 'Status'
          click_button 'Update Task'
          expect(page).to have_content 'Title: updated_title'
          expect(page).to have_content 'Status: done'
          expect(page).to have_content 'Task was successfully updated.'
          expect(current_path).to eq task_path(task)
        end
      end

      context 'ã‚¿ã‚¤ãƒˆãƒ«ãŒæœªå…¥åŠ›' do
        it 'ã‚¿ã‚¹ã‚¯ã®ç·¨é›†ãŒå¤±æ•—ã™ã‚‹' do
          fill_in 'Title', with: nil
          select :todo, from: 'Status'
          click_button 'Update Task'
          expect(page).to have_content '1 error prohibited this task from being saved'
          expect(page).to have_content "Title can't be blank"
          expect(current_path).to eq task_path(task)
        end
      end

      context 'ç™»éŒ²æ¸ˆã®ã‚¿ã‚¤ãƒˆãƒ«ã‚’å…¥åŠ›' do
        it 'ã‚¿ã‚¹ã‚¯ã®ç·¨é›†ãŒå¤±æ•—ã™ã‚‹' do
          fill_in 'Title', with: other_task.title
          select :todo, from: 'Status'
          click_button 'Update Task'
          expect(page).to have_content '1 error prohibited this task from being saved'
          expect(page).to have_content "Title has already been taken"
          expect(current_path).to eq task_path(task)
        end
      end

      context 'ä»–ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã‚¿ã‚¹ã‚¯ç·¨é›†ãƒšãƒ¼ã‚¸ã«ã‚¢ã‚¯ã‚»ã‚¹' do
        ğŸ’œlet!(:other_user) { create(:user, email: "other_user@example.com") }
        ğŸ’œlet!(:other_task) { create(:task, user: other_user) }

        it 'ç·¨é›†ãƒšãƒ¼ã‚¸ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ãŒå¤±æ•—ã™ã‚‹' do
          visit edit_task_path(other_task)
          expect(page).to have_content 'Forbidden access.'
          expect(current_path).to eq root_path
        end
      end
    end

    describe 'ã‚¿ã‚¹ã‚¯å‰Šé™¤' do
      ğŸ’™let!(:task) { create(:task, user: user) }

      it 'ã‚¿ã‚¹ã‚¯ã®å‰Šé™¤ãŒæˆåŠŸã™ã‚‹' do
        visit tasks_path
        click_link 'Destroy'
        expect(page.accept_confirm).to eq 'Are you sure?'
        expect(page).to have_content 'Task was successfully destroyed'
        expect(current_path).to eq tasks_path
       ğŸ’™expect(page).not_to have_content task.title
      end
    end
  end
end
~~~
***

## before do~end
ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ã®å‰ã«ä½•ã‹ã—ã‚‰ã®å‡¦ç†ï¼ˆä¾‹ãˆã°ãƒ‡ãƒ¼ã‚¿ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ï¼‰ã‚’è¡Œã„ãŸã„ã¨ãã«ä½¿ã†ã€‚     
æœ‰åŠ¹ç¯„å›²ã¯å®šç¾©ã—ãŸãƒ–ãƒ­ãƒƒã‚¯å†…ã«ãªã‚‹ã®ã§ describeã§å®šç¾©ã™ã‚‹ã“ã¨ãŒå¤šã„ã€‚    
è¦‹æœ¬ã®ãƒ†ã‚¹ãƒˆã§ã¯å…¨ã¦ã®ãƒ†ã‚¹ãƒˆãŒ beforeã‚’å®šç¾©ã—ãŸãƒ–ãƒ­ãƒƒã‚¯å†…ãªã®ã§å…¨ã¦ã«é©å¿œã•ã‚Œã‚‹ã€‚    
    
ã¾ãŸãƒ‡ãƒ¡ãƒªãƒƒãƒˆã¨ã—ã¦ã¯ beforeã®å®šç¾©ã—ãŸã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãŒå¿…è¦ãªã„ãƒ†ã‚¹ãƒˆã§ã‚‚é©å¿œã•ã‚Œã‚‹ã®ã§ç„¡é§„ã«æ™‚é–“ãŒã‹ã‹ã‚‹ã“ã¨ãŒã‚ã‚‹ã€‚    
    
ğŸ©·ãƒ–ãƒ­ãƒƒã‚¯ãªã®ã§ do~endã§ã¯ãªãã€{}ã§æ›¸ã„ã¦ã‚‚OK!
***

## let
letã¯ã€é…å»¶è©•ä¾¡ã‚¿ã‚¤ãƒ—ã§å®šç¾©ã—ãŸå®šæ•°ãŒåˆã‚ã¦ä½¿ã‚ã‚ŒãŸã¨ãã«ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒå­˜åœ¨ã™ã‚‹ã‚ˆã†ã«ãªã‚‹ã€‚    
å…¨ã¦ã®ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ã§å¿…è¦ãªã‚ã‘ã§ã¯ãªã„ãƒ‡ãƒ¼ã‚¿ã‚’è¨­å®šã™ã‚‹ã®ã«ä¾¿åˆ©ã€‚

ğŸ§¡let(:user)ã¯ login(user)ã®userã§åˆã‚ã¦ä½¿ã‚ã‚Œã¦è©•ä¾¡ã•ã‚ŒãŸã€‚  
ğŸ’šlet(:task)ã¯ edit_task_path(task)ã®taskã§åˆã‚ã¦ä½¿ã‚ã‚Œè©•ä¾¡ã•ã‚ŒãŸã€‚
***

## let!
letã¨é•ã„ã€å³æ™‚è©•ä¾¡ã‚¿ã‚¤ãƒ—ãªã®ã§å®šç¾©ã—ãŸã‚‰ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒå­˜åœ¨ã™ã‚‹ã‚ˆã†ã«ãªã‚‹ã€‚    
ç°¡å˜ã«ã„ã†ã¨ã€let!ã¯letã‚’beforeã«æ¸¡ã—ã¦ã„ã‚‹ã ã‘ã€‚    
å…¨ã¦ã®ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ã§ä½¿ã†ãƒ‡ãƒ¼ã‚¿ã¯ let!ã«ã™ã‚‹ã¨ã„ã„ã€‚

ğŸ©µ ãƒ†ã‚¹ãƒˆã®é–‹å§‹å‰ã« visit edit_task_path(task)ã‚’å®Ÿè¡Œã™ã‚‹ã¨ãã«ã¯ taskãŒå­˜åœ¨ã—ãªã„ã¨ã„ã‘ãªã„ã®ã§ã€let!     
    
ğŸ’œ ã“ã®ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ã§ã¯ã€ä»–ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã‚¿ã‚¹ã‚¯ã‚’ç·¨é›†ã—ã‚ˆã†ã¨ã—ãŸå ´åˆã®æŒ™å‹•ã‚’ãƒ†ã‚¹ãƒˆã—ã¦ã„ã‚‹ãŸã‚ã€    
ãƒ†ã‚¹ãƒˆãŒå§‹ã¾ã‚‹å‰ã« other_userã¨ãã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã® other_taskã‚’ç”Ÿæˆã™ã‚‹å¿…è¦ãŒã‚ã‚‹ã®ã§ã€let!    
    
ğŸ’™ letã ã¨ task.titleã§åˆã‚ã¦è©•ä¾¡ã•ã‚Œã‚‹ã®ã§ã€    
ã‚¿ã‚¹ã‚¯ã‚’å‰Šé™¤ã™ã‚‹æ“ä½œãŒå®Œäº†ã—ãŸå¾Œã«åˆã‚ã¦ã‚¿ã‚¹ã‚¯ãŒç”Ÿæˆã•ã‚Œã¦ã—ã¾ã„ã€ãƒ†ã‚¹ãƒˆã®ç›®çš„ãŒæœãŸã›ãªããªã‚‹ã€‚
***

## letã®ä¸Šæ›¸ã
ä¾‹ãˆã°åŒã˜ describeãƒ–ãƒ­ãƒƒã‚¯å†…ã§ let(:task)ã¨ã„ã†åå‰ãŒæ•°å›å‡ºã¦ããŸã‚‰ãã‚Œã¯ã€ä¸Šæ›¸ãã‚’ã—ã¦ã„ã‚‹ã€‚    
é•ã†ãƒ–ãƒ­ãƒƒã‚¯ãªã‚‰åˆ¥ã®å¤‰æ•°ã¨ã—ã¦æ‰±ã‚ã‚Œã‚‹ã®ã§ä¸Šæ›¸ãã—ã¦ã„ãªã„ã€‚(è¦‹æœ¬ã§ã¯ä¸Šæ›¸ããªã—)
***
