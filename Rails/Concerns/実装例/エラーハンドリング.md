[å‚è€ƒ](https://qiita.com/mmaumtjgj/items/5c98ae3d21fa4f27c93c)

# apiã®ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
apiã§ã®ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã‚’ä½œã‚‹ã€‚

ã“ã®ã‚ˆã†ã« JSONå½¢å¼ã§ãƒ–ãƒ©ã‚¦ã‚¶è¡¨ç¤ºã™ã‚‹ã‚ˆã†ã«ã™ã‚‹ã€‚

[![Image from Gyazo](https://i.gyazo.com/9989b71ccfad6281a95c629d1f92dc78.png)](https://gyazo.com/9989b71ccfad6281a95c629d1f92dc78)
***

# concernsãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã€ãƒ•ã‚¡ã‚¤ãƒ«ã®ä½œæˆ
`app/controllers/concerns`ã‚’ä½œæˆã€ä»Šå›ã¯ apiç”¨ã®ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ãªã®ã§[åå‰ç©ºé–“](https://github.com/Tarara33/TIL/blob/main/Rails/Rails%E3%83%A1%E3%83%A2/%E5%90%8D%E5%89%8D%E7%A9%BA%E9%96%93.md)ã‚’ã¤ã‘ã¦ã€  
`app/controllers/concerns/api/exception_handler.rb`ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã€‚
***

# ãƒ•ã‚¡ã‚¤ãƒ«ç·¨é›†
## â‘  jsonå½¢å¼ã§ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤ºãªã©ã™ã‚‹ãƒ¡ã‚½ãƒƒãƒ‰ã‚’ä½œã‚‹
~~~
[app/controllers/concerns/api/exception_handler.rb]

module Api::ExceptionHandler
  extend ActiveSupport::Concern
  
  private

    def render_error(code, message, ğŸ©µ*error_messages)
      â­ï¸response = {
        message: message,
        errors: error_messagesğŸ’›.compact
      }
      render json: â­ï¸response, ğŸ©·status: code
    end
end
~~~
â­ï¸ render_errorãƒ¡ã‚½ãƒƒãƒ‰ã®è¿”ã™å½¢å¼ã¯ã€`render json: â­ï¸response`ã§å¤‰æ•° responseã®å½¢ã§è¿”ã•ã‚Œã‚‹ã€‚  
ğŸ©· statusã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ä½¿ã£ã¦ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã«ã©ã® HTTPã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚³ãƒ¼ãƒ‰ã§ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’è¿”ã™ã‹ã‚’æ˜ç¤ºã—ã¦ã„ã‚‹ã€‚

ğŸ©µ å¼•æ•°ã« ï¼ŠãŒã¤ã„ã¦ã‚‹ã®ã¯[å¯å¤‰é•·å¼•æ•°](https://github.com/Tarara33/TIL/blob/main/Ruby/%E3%83%A1%E3%83%A2/%EF%BC%8A.md)ã€‚  
ğŸ’› [compact](https://github.com/Tarara33/TIL/blob/main/Ruby/%E3%83%A1%E3%82%BD%E3%83%83%E3%83%89/%E5%8D%98%E4%BD%93/compact.md)ã¯è‡ªèº«ã‹ã‚‰ nilã‚’å–ã‚Šé™¤ã„ãŸé…åˆ—ã‚’ç”Ÿæˆã—ã¦è¿”ã™ã€‚

ã¤ã¾ã‚Šã€error_messagesãŒè¤‡æ•°ã‚ã£ãŸå ´åˆã¯
~~~
{
  message: 'ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸',
  exception: ["ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼‘", "ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸2"]
}
~~~
ã®ã‚ˆã†ã«è¿”ã™ã€‚

### â“ status: codeæ›¸ã‹ãªã„ã¨ã©ã†ãªã‚‹ï¼Ÿï¼Ÿ
ã“ã‚Œã«ã‚ˆã‚Šã€ã‚¨ãƒ©ãƒ¼ã®ç¨®é¡ã«å¿œã˜ã¦é©åˆ‡ãªHTTPã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚³ãƒ¼ãƒ‰ï¼ˆ400, 404, 500ãªã©ï¼‰ãŒè¨­å®šã•ã‚Œã‚‹ã€‚  
ã“ã‚ŒãŒãªã„ã¨ã€ã©ã®ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¦ã‚‚ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚³ãƒ¼ãƒ‰ï¼ˆRailsã§ã¯é€šå¸¸200 OKï¼‰ã§ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒè¿”ã•ã‚Œã¦ã—ã¾ã†ã€‚  
***

## â‘¡ ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚³ãƒ¼ãƒ‰åˆ¥ã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ä½œã‚‹
~~~
[app/controllers/concerns/api/exception_handler.rb]

module Api::ExceptionHandler
  extend ActiveSupport::Concern

  private

    def render_400ğŸ’š(exception = nil, messages = nil)
      render_error(400, 'Bad Request', ğŸ§¡exception&.message, ğŸ§¡*messages)
    end

    def render_404(exception = nil, messages = nil)
      render_error(404, 'Record Not Found', exception&.message, *messages)
    end

    def render_500(exception = nil, messages = nil)
      render_error(500, 'Internal Server Error', exception&.message, *messages)
    end

    def render_error(code, message, *error_messages)
      response = {
        message: message,
        errors: error_messages.compact
      }
      render json: response, status: code
    end
end
~~~
ğŸ’š ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå¼•æ•°ã‚’è¨­å®šã—ã¦ã„ã‚‹ã€‚
### â“ ãªãœã„ã¡ã„ã¡ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå¼•æ•°ã¤ã‘ãŸï¼Ÿï¼Ÿ
ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå¼•æ•°ã‚’ä½¿ã†ç†ç”±ã¯ã€ãƒ¡ã‚½ãƒƒãƒ‰ã‚’æŸ”è»Ÿã«ä½¿ãˆã‚‹ã‚ˆã†ã«ã™ã‚‹ãŸã‚ã€‚  
exception(ä¾‹å¤–ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ)ãŒã‚ã‚Œã°ã€ãã®ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã«å«ã‚ã‚‹ã“ã¨ãŒã§ãã‚‹ã—ã€  
messages(è¿½åŠ ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸)ãŒã‚ã‚Œã°ãã‚Œã‚‚ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã«å«ã‚ã‚‰ã‚Œã‚‹ã€‚  

ã‚‚ã—ä¾‹å¤–ã‚„ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒãªã„å ´åˆã§ã‚‚ã€ãƒ¡ã‚½ãƒƒãƒ‰ã‚’ä½¿ãˆã‚‹ã‚ˆã†ã«ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå¼•æ•°ã‚’ nilã«ã—ã¦ãŠãã€‚  
ã“ã‚Œã«ã‚ˆã‚Šã€ãƒ¡ã‚½ãƒƒãƒ‰ã‚’å‘¼ã³å‡ºã™ã¨ãã«ã©ã¡ã‚‰ã®å¼•æ•°ã‚‚çœç•¥ã§ãã‚‹ã—ã€ã‚¨ãƒ©ãƒ¼æƒ…å ±ãŒã‚ã‚‹ã¨ãã ã‘æŒ‡å®šã™ã‚Œã°ã„ã„ã€‚
***

### â“ å¼•æ•°ãŒå¢—ãˆã¦ã‚‹
ğŸ§¡ å®šç¾©ã—ãŸ render_errorã®å¼•æ•°ã¯ï¼“ã¤ãªã®ã«ã€å‘¼ã‚“ã æ™‚ã¯ï¼”ã¤ã«ãªã£ã¦ã‚‹ã€‚  
=> `*error_messages`ã¨å¯å¤‰é•·å¼•æ•°ã«ã—ã¦ã‚‹ã‹ã‚‰ã€  
å®Ÿéš›ã«ã¯3ã¤ç›®ã®å¼•æ•° exception&.messagesã¨4ã¤ç›®ã®å¼•æ•° *messagesãŒã€  
*error_messagesã¨ã—ã¦ã²ã¨ã¾ã¨ã‚ã«ãªã£ã¦ render_errorã¸æ¸¡ã•ã‚Œã¦ã„ã‚‹ã€‚
***

## â‘¢ ã‚¨ãƒ©ãƒ¼ãŒå‡ºãŸéš›ã®å‡¦ç†ã‚’æ›¸ã
ç¾çŠ¶ã ã¨ã€å®Ÿéš›ã©ã“ã‹ã®ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼ã« includeã—ã¦ã€ã‚¨ãƒ©ãƒ¼ãŒå‡ºã¦ã‚‚ã€ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã•ã‚Œãªã„ã€‚  
ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã®å†…å®¹ã¯æ›¸ã„ã¦ã„ã‚‹ãŒã€ã“ã®ã‚¨ãƒ©ãƒ¼ã«ã¯ã“ã®ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ï¼ã¨æŒ‡å®šã—ã¦ãªã„ã‹ã‚‰ã€‚
~~~
[app/controllers/concerns/api/exception_handler.rb]

module Api::ExceptionHandler
  extend ActiveSupport::Concern

  ğŸ’™included do
    ğŸ’œrescue_from StandardError, with: :render_500
    rescue_from ActiveRecord::RecordNotFound, with: :render_404
  end

  private

    def render_400(exception = nil, messages = nil)
      render_error(400, 'Bad Request', exception&.message, *messages)
    end

    def render_404(exception = nil, messages = nil)
      render_error(404, 'Record Not Found', exception&.message, *messages)
    end

    def render_500(exception = nil, messages = nil)
      render_error(500, 'Internal Server Error', exception&.message, *messages)
    end

    def render_error(code, message, *error_messages)
      response = {
        message: message,
        errors: error_messages.compact
      }
      render json: response, status: code
    end
end
~~~
ğŸ’™ ActiveSupport::Concernã‚’ extendã™ã‚‹ã¨ã€includedãƒ¡ã‚½ãƒƒãƒ‰ã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ãŒã§ãã‚‹ã‚ˆã†ã«ãªã‚‹ã€‚  
includedãƒ¡ã‚½ãƒƒãƒ‰ã¯ã€includeã—ãŸéš›ã«å‘¼ã³å‡ºã•ã‚Œã‚‹ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ãƒ¡ã‚½ãƒƒãƒ‰ã€‚  

ğŸ’œ [rescue_from](https://github.com/Tarara33/TIL/blob/main/Rails/Controller/rescue_from.md)ã¯ä¾‹å¤–ã®ç¨®é¡ã‚’æŒ‡å®šã—ã€ãã®ã¨ãã«å®Ÿè¡Œã™ã‚‹å‡¦ç†ã‚’è¨˜è¿°ã™ã‚‹ã€‚
***

# ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼ã«èª­ã¿è¾¼ã¾ã™
~~~
[ä½¿ç”¨ã—ãŸã„ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼ãƒ•ã‚¡ã‚¤ãƒ«]
include Api::ExceptionHandler
~~~
***
